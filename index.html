<!DOCTYPE html>
<html class="dark" lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta name="referrer" content="no-referrer" />
    <title>MuslimPro Dashboard - V9 TV Ready</title>
    
    <!-- PWA Manifest untuk TV Browser -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIk11c2xpbVBybyBEYXNoYm9hcmQiLAogICJzaG9ydF9uYW1lIjogIk11c2xpbVBybyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDUwZTExIiwKICAidGhlbWVfY29sb3IiOiAiIzEwYjk4MSIKfQ==" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Scheherazade+New:wght@400;700&family=Orbitron:wght@400;700&family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet"/>
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <!-- LOAD SCRIPT (Wajib Internet saat Start Awal) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--color-primary)',
                        secondary: 'var(--color-secondary)',
                        accent: 'var(--color-accent)',
                        "background-dark": 'var(--color-bg)', 
                        "surface-dark": 'var(--color-surface)',
                        "text-main": 'var(--color-text)',
                        "text-muted": 'var(--color-text-muted)',
                    },
                    fontFamily: {
                        "display": ['var(--font-body)', "sans-serif"],
                        "arabic": ["Amiri", "serif"],
                        "calligraphy": ['var(--font-heading)', "serif"], 
                        "quran": ["Scheherazade New", "serif"],
                    },
                    animation: {
                        'marquee': 'marquee 30s linear infinite',
                        'fade-in': 'fadeIn 0.8s ease-out',
                        'float': 'float 6s ease-in-out infinite',
                        'spin-slow': 'spin 60s linear infinite',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        marquee: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(-100%)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            overflow: hidden; 
            transition: background-color 0.5s ease, color 0.5s ease;
            cursor: none; /* Hide cursor for TV */
        }
        /* Show cursor only when moving (optional, requires JS, but simple CSS hide is better for TV) */
        body:hover { cursor: default; }

        /* --- THEME DEFINITIONS --- */
        :root {
            /* Default: Royal Gold */
            --color-bg: #050e11;
            --color-surface: rgba(6, 78, 59, 0.85);
            --color-primary: #10b981;
            --color-secondary: #064e3b;
            --color-accent: #D4AF37; /* Gold */
            --color-text: #f1f5f9;
            --color-text-muted: #94a3b8;
            --font-heading: 'Aref Ruqaa';
            --font-body: 'Plus Jakarta Sans';
            --glass-border: rgba(212, 175, 55, 0.2);
            --pattern-opacity: 0.3;
        }

        /* Theme: Classic Green */
        body.theme-classic-green {
            --color-bg: #022c22; --color-surface: rgba(20, 83, 45, 0.9); --color-primary: #4ade80; --color-secondary: #14532d; --color-accent: #22c55e; --font-heading: 'Amiri'; --glass-border: rgba(34, 197, 94, 0.3);
        }
        /* Theme: Modern Neon */
        body.theme-modern-neon {
            --color-bg: #000000; --color-surface: rgba(20, 20, 20, 0.95); --color-primary: #06b6d4; --color-secondary: #083344; --color-accent: #00f3ff; --color-text: #e0f2fe; --font-heading: 'Orbitron'; --font-body: 'Plus Jakarta Sans'; --glass-border: rgba(6, 182, 212, 0.5); --pattern-opacity: 0.1;
        }
        /* Theme: Clean Minimal */
        body.theme-clean-minimal {
            --color-bg: #f8fafc; --color-surface: rgba(255, 255, 255, 0.9); --color-primary: #0f172a; --color-secondary: #e2e8f0; --color-accent: #0f172a; --color-text: #0f172a; --color-text-muted: #64748b; --font-heading: 'Lato'; --font-body: 'Lato'; --glass-border: rgba(15, 23, 42, 0.1); --pattern-opacity: 0.05;
        }
        /* Theme: Nature Earth */
        body.theme-nature-earth {
            --color-bg: #292524; --color-surface: rgba(68, 64, 60, 0.9); --color-primary: #d6d3d1; --color-secondary: #44403c; --color-accent: #ea580c; --color-text: #fafaf9; --font-heading: 'Cinzel'; --glass-border: rgba(234, 88, 12, 0.3);
        }
        /* Theme: Ocean Blue */
        body.theme-ocean-blue {
            --color-bg: #0c4a6e; --color-surface: rgba(12, 74, 110, 0.9); --color-primary: #38bdf8; --color-secondary: #075985; --color-accent: #7dd3fc; --font-heading: 'Plus Jakarta Sans'; --glass-border: rgba(125, 211, 252, 0.3);
        }

        .islamic-pattern {
            background-color: transparent;
            background-image: radial-gradient(circle at 50% 50%, var(--color-accent) 0%, transparent 80%), 
                              url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23888888' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .mihrab-shape {
            border-radius: 100px 100px 10px 10px;
            border: 1px solid var(--color-accent); 
        }

        body.theme-clean-minimal .mihrab-shape,
        body.theme-modern-neon .mihrab-shape {
            border-radius: 16px;
        }

        .glass-panel {
            background: var(--color-surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-accent); border-radius: 4px; }
        
        .text-shadow-glow { text-shadow: 0 0 10px var(--color-accent); }
    </style>
</head>
<body class="bg-background-dark text-text-main transition-colors duration-500">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, memo, useContext, useRef, createContext } = React;
        const { createRoot } = ReactDOM;
        const { HashRouter, Routes, Route, Link, useNavigate } = ReactRouterDOM;

        // --- FIREBASE SETUP ---
        let app = null, auth = null, db = null, appId = 'default-app-id', firebaseAvailable = false;
        try {
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                // FIX: Force Long Polling to avoid connection errors in certain environments
                try {
                    db.settings({ experimentalForceLongPolling: true, merge: true });
                } catch(e) { console.log("Firestore settings applied", e); }
                
                firebaseAvailable = true;
            } else { console.warn("Firebase config not found."); }
        } catch (e) { console.warn("Firebase initialization failed.", e); }

        // --- UTILS & CALCULATIONS ---
        const BEEP_AUDIO_BASE64 = "data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU";
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
        
        const compressImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 1280 / img.width;
                    canvas.width = 1280; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                }
            }
        });

        const adjustTime = (timeStr, minutesToAdd) => {
            if (!timeStr) return "";
            const [h, m] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(h, m + (minutesToAdd || 0));
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        };

        const getCorrectedDate = (offsetMinutes = 0) => {
            const now = new Date();
            if (!offsetMinutes) return now;
            return new Date(now.getTime() + offsetMinutes * 60000);
        };

        // Prayer Calc Engine (Standard)
        const PrayerCalc = {
            d2r: (d) => d * Math.PI / 180.0,
            r2d: (r) => r * 180.0 / Math.PI,
            fixHour: (a) => { 
                a = a - 24.0 * Math.floor(a / 24.0); 
                return a < 0 ? a + 24.0 : a; 
            },
            sunPosition: (jd) => {
                const D = jd - 2451545.0;
                const g = PrayerCalc.fixHour(357.529 + 0.98560028 * D);
                const q = PrayerCalc.fixHour(280.459 + 0.98564736 * D);
                const L = PrayerCalc.fixHour(q + 1.915 * Math.sin(PrayerCalc.d2r(g)) + 0.020 * Math.sin(PrayerCalc.d2r(2 * g)));
                const e = 23.439 - 0.00000036 * D;
                const RA = PrayerCalc.r2d(Math.atan2(Math.cos(PrayerCalc.d2r(e)) * Math.sin(PrayerCalc.d2r(L)), Math.cos(PrayerCalc.d2r(L)))) / 15.0;
                const RA_L = PrayerCalc.fixHour(L / 15.0);
                const RA_final = PrayerCalc.fixHour(RA + (RA_L - PrayerCalc.fixHour(RA))); 
                const Decl = PrayerCalc.r2d(Math.asin(Math.sin(PrayerCalc.d2r(e)) * Math.sin(PrayerCalc.d2r(L))));
                const EqT = q / 15.0 - RA_final;
                return { declination: Decl, equation: EqT };
            },
            getTimes: (date, lat, lng, timeZone, offsets = {}, method = 20) => {
                let year = date.getFullYear(), month = date.getMonth() + 1, day = date.getDate();
                if (month <= 2) { year -= 1; month += 12; }
                const A = Math.floor(year / 100);
                const B = 2 - A + Math.floor(A / 4);
                const JD = Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + B - 1524.5;
                const sun = PrayerCalc.sunPosition(JD);
                const D = sun.declination;
                const EqT = sun.equation;
                
                let fajrAngle = 20; 
                let ishaAngle = 18;
                if (method === 'muhammadiyah') { fajrAngle = 18; ishaAngle = 18; }

                const computeTime = (angle, mode) => {
                   const P1 = -Math.sin(PrayerCalc.d2r(angle)) - Math.sin(PrayerCalc.d2r(lat)) * Math.sin(PrayerCalc.d2r(D));
                   const P2 = Math.cos(PrayerCalc.d2r(lat)) * Math.cos(PrayerCalc.d2r(D));
                   return PrayerCalc.r2d(Math.acos(P1 / P2) / 15.0); 
                };
                const dhuhr = 12 + EqT - lng / 15;
                const sunAngleTime = computeTime(0.833, 0); 
                const sunrise = dhuhr - sunAngleTime;
                const sunset = dhuhr + sunAngleTime;
                const fajr = dhuhr - computeTime(fajrAngle, 1);
                const isha = dhuhr + computeTime(ishaAngle, 1);
                const asrAngle = Math.atan(1 / (1 + Math.tan(PrayerCalc.d2r(Math.abs(lat - D)))));
                const asr = dhuhr + PrayerCalc.r2d(Math.acos((Math.sin(asrAngle) - Math.sin(PrayerCalc.d2r(lat)) * Math.sin(PrayerCalc.d2r(D))) / (Math.cos(PrayerCalc.d2r(lat)) * Math.cos(PrayerCalc.d2r(D))))) / 15.0;
                
                const format = (t, correction = 0) => {
                    const time = PrayerCalc.fixHour(t + timeZone);
                    const hours = Math.floor(time);
                    const minutes = Math.floor((time - hours) * 60);
                    const d = new Date();
                    d.setHours(hours, minutes + (correction || 0), 0); 
                    return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                };
                return {
                    Fajr: format(fajr, offsets.Fajr), Sunrise: format(sunrise, offsets.Sunrise), Dhuhr: format(dhuhr, offsets.Dhuhr),
                    Asr: format(asr, offsets.Asr), Maghrib: format(sunset, offsets.Maghrib), Isha: format(isha, offsets.Isha)
                };
            }
        };

        const fetchPrayerTimesFromAPI = async (lat, lng, offsets, method = 20) => {
            try {
                if (method === 'muhammadiyah') return null; 
                const response = await fetch(`https://api.aladhan.com/v1/timings/${Math.floor(Date.now() / 1000)}?latitude=${lat}&longitude=${lng}&method=${method}`); 
                if (!response.ok) throw new Error("Failed to fetch prayer times");
                const data = await response.json();
                const timings = data.data.timings;
                const correctedTimings = {
                    Fajr: adjustTime(timings.Fajr, offsets.Fajr),
                    Sunrise: adjustTime(timings.Sunrise, offsets.Sunrise),
                    Dhuhr: adjustTime(timings.Dhuhr, offsets.Dhuhr),
                    Asr: adjustTime(timings.Asr, offsets.Asr),
                    Maghrib: adjustTime(timings.Maghrib, offsets.Maghrib),
                    Isha: adjustTime(timings.Isha, offsets.Isha)
                };
                return { ...data.data, timings: correctedTimings }; 
            } catch (error) {
                console.log("API Error, switching to offline calc");
                return null;
            }
        };

        // --- CONTEXT ---
        const SettingsContext = createContext();
        const SettingsProvider = ({children}) => {
            const [user, setUser] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('muslimProSettings_v9_tv');
                const defaultSettings = {
                    general: { 
                        mosqueName: "Masjid Al-Multazam", 
                        method: 20, 
                        iqamahDelay: 10, 
                        template: 'classic', 
                        prayerDuration: 10, 
                        fridayPrayerDuration: 30, 
                        hijriAdjustment: 0, 
                        timeCorrection: 0 
                    },
                    location: { city: "Jakarta Pusat", lat: -6.1754, lng: 106.8272, manual: false },
                    offsets: { Fajr: 2, Sunrise: -2, Dhuhr: 2, Asr: 2, Maghrib: 2, Isha: 2 },
                    appearance: { theme: 'royal-gold', bgImage: "https://images.unsplash.com/photo-1519817650390-64a93db51149?q=80&w=2574&auto=format&fit=crop" },
                    runningText: { active: true, texts: ["Selamat Datang di Masjid", "Luruskan dan Rapatkan Shaf"] },
                    financials: { balance: 0, income: 0, expense: 0 },
                    fridayInfo: { khatib: "-", imam: "-", muadzin: "-" },
                    slides: [],
                    audio: { isMuted: false },
                    drive: { apiKey: "AIzaSyBA3RAQhqA7YDowJ5NC6qZC09GriD9M3ZM", folderUrl: "https://drive.google.com/drive/folders/1hO0oN1sY5o4tR44V_pyCqEk8D_pJ_LBa?usp=sharing" }
                };
                return saved ? {...defaultSettings, ...JSON.parse(saved)} : defaultSettings;
            });
            const [todaysTimings, setTodaysTimings] = useState(null);
            const [hijriDate, setHijriDate] = useState("");

            // Monitor Online Status for TV Resilience
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            useEffect(() => {
                if (firebaseAvailable && auth) {
                    const initAuth = async () => {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await auth.signInWithCustomToken(__initial_auth_token); } 
                        else { await auth.signInAnonymously(); }
                    };
                    initAuth();
                    return auth.onAuthStateChanged(setUser);
                }
            }, []);

            useEffect(() => {
                document.body.className = `bg-background-dark text-text-main transition-colors duration-500 theme-${settings.appearance.theme}`;
                localStorage.setItem('muslimProSettings_v9_tv', JSON.stringify(settings));
            }, [settings]);

            useEffect(() => {
                const calc = async () => {
                    const method = settings.general.method;
                    // Try API if online, else fallback
                    if(isOnline && method !== 'muhammadiyah') {
                        try {
                            const res = await fetch(`https://api.aladhan.com/v1/timings/${Math.floor(Date.now()/1000)}?latitude=${settings.location.lat}&longitude=${settings.location.lng}&method=${settings.general.method}`);
                            const data = await res.json();
                            const timings = data.data.timings;
                            const corrected = {
                                Fajr: adjustTime(timings.Fajr, settings.offsets.Fajr),
                                Sunrise: adjustTime(timings.Sunrise, settings.offsets.Sunrise),
                                Dhuhr: adjustTime(timings.Dhuhr, settings.offsets.Dhuhr),
                                Asr: adjustTime(timings.Asr, settings.offsets.Asr),
                                Maghrib: adjustTime(timings.Maghrib, settings.offsets.Maghrib),
                                Isha: adjustTime(timings.Isha, settings.offsets.Isha)
                            };
                            setTodaysTimings(corrected);
                            return;
                        } catch(e){
                            console.log("API Fail, using offline calc");
                        }
                    }
                    // Offline Calculation Fallback
                    const today = new Date();
                    const tzOffset = -today.getTimezoneOffset() / 60;
                    const t = PrayerCalc.getTimes(today, parseFloat(settings.location.lat), parseFloat(settings.location.lng), tzOffset, settings.offsets, settings.general.method);
                    setTodaysTimings(t);
                };
                calc();
                // Recalculate periodically to handle date changes if left running for days
                const interval = setInterval(calc, 6 * 60 * 60 * 1000); 
                return () => clearInterval(interval);
            }, [settings.location, settings.general.method, settings.offsets, isOnline]);

            useEffect(() => {
                if(!todaysTimings) return;
                const d = new Date();
                const [h,m] = todaysTimings.Maghrib.split(':');
                if(d.getHours() > h || (d.getHours() == h && d.getMinutes() >= m)) d.setDate(d.getDate()+1);
                d.setDate(d.getDate() + (settings.general.hijriAdjustment || 0));
                setHijriDate(new Intl.DateTimeFormat('id-TN-u-ca-islamic',{day:'numeric',month:'long',year:'numeric'}).format(d));
            }, [todaysTimings, settings.general.hijriAdjustment]);

            const updateSettings = (sec, key, val) => {
                setSettings(p => {
                    if(sec === 'root') return {...p, [key]:val};
                    return {...p, [sec]: {...p[sec], [key]:val}};
                });
            };
            const handleFileUpload = async (file, type) => {
                if (type === 'video') {
                    if (file.size > 3 * 1024 * 1024) {
                        alert("Ukuran video terlalu besar. Maksimal 3MB untuk penyimpanan browser.");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const url = e.target.result;
                        setSettings(p => ({...p, slides: [...(p.slides||[]), {type:'video', url, duration:30}]}));
                    };
                    reader.readAsDataURL(file);
                } else if (type === 'bg' || type === 'slide') {
                    const url = await compressImage(file);
                    if(type === 'bg') updateSettings('appearance', 'bgImage', url);
                    else setSettings(p => ({...p, slides: [...(p.slides||[]), {type:'image', url, duration:10}]}));
                }
            };

            return <SettingsContext.Provider value={{settings, updateSettings, todaysTimings, hijriDate, handleFileUpload, setSettings, user, db, appId, firebaseAvailable, isOnline}}>{children}</SettingsContext.Provider>;
        };

        // --- COMPONENTS ---
        const StartOverlay = ({ onStart }) => (
            <div className="fixed inset-0 z-[200] bg-black/90 flex flex-col items-center justify-center p-4">
                <div className="bg-surface-dark p-8 rounded-2xl border border-white/10 text-center max-w-lg">
                    <span className="material-symbols-outlined text-6xl text-accent mb-4 animate-bounce">play_circle</span>
                    <h1 className="text-2xl font-bold text-white mb-2">Selamat Datang</h1>
                    <p className="text-slate-400 mb-6">Klik tombol di bawah untuk memulai dashboard dan mengaktifkan suara adzan.</p>
                    <button onClick={onStart} className="bg-accent hover:bg-white text-black font-bold py-3 px-8 rounded-full text-lg shadow-[0_0_20px_rgba(212,175,55,0.4)] transition-all transform hover:scale-105">
                        MULAI DASHBOARD
                    </button>
                </div>
            </div>
        );

        const ClockWidget = memo(({ nextPrayer, status, timeDiff }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const i = setInterval(()=>setTime(new Date()),1000); return ()=>clearInterval(i); }, []);
            
            // Format Countdown
            const fmt = (n) => String(Math.floor(n)).padStart(2, '0');
            const h = fmt((timeDiff / (1000 * 60 * 60)) % 24);
            const m = fmt((timeDiff / (1000 * 60)) % 60);
            const s = fmt((timeDiff / 1000) % 60);

            const isIqamah = status === 'iqamah';

            return (
                <div className="flex flex-col items-center justify-center relative animate-fade-in text-center">
                    <div className="absolute inset-0 border-2 border-accent/20 rounded-full animate-spin-slow"></div>
                    
                    {/* JAM UTAMA */}
                    <div className="font-calligraphy text-7xl md:text-9xl text-text-main drop-shadow-xl leading-none">
                        {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
                    </div>
                    <div className="text-text-muted font-display text-xl tracking-[0.5em] mt-2 mb-6">
                        {time.toLocaleTimeString([], { second: '2-digit' })}
                    </div>

                    {/* COUNTDOWN SECTION */}
                    {nextPrayer && (
                        <div className={`mt-4 p-4 rounded-xl border border-accent/30 bg-black/40 backdrop-blur-md transition-all duration-500 ${isIqamah ? 'border-red-500 bg-red-900/30' : ''}`}>
                            <div className={`text-xs font-bold uppercase tracking-widest mb-2 ${isIqamah ? 'text-red-400 animate-pulse' : 'text-accent'}`}>
                                {isIqamah ? `MENUJU IQOMAH ${nextPrayer.name.toUpperCase()}` : `MENUJU ${nextPrayer.name.toUpperCase()}`}
                            </div>
                            <div className="flex gap-3 text-2xl md:text-4xl font-bold font-display text-text-main">
                                <div className="flex flex-col items-center"><span className={isIqamah?'text-red-400':''}>{h}</span><span className="text-[8px] text-text-muted uppercase">Jam</span></div>
                                <span className="animate-pulse">:</span>
                                <div className="flex flex-col items-center"><span className={isIqamah?'text-red-400':''}>{m}</span><span className="text-[8px] text-text-muted uppercase">Menit</span></div>
                                <span className="animate-pulse">:</span>
                                <div className="flex flex-col items-center"><span className={isIqamah?'text-red-400':''}>{s}</span><span className="text-[8px] text-text-muted uppercase">Detik</span></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        const KajianSlide = memo(({ slide }) => (
            <div className="glass-panel p-10 rounded-xl text-center animate-fade-in w-full max-w-4xl mx-auto border-l-4 border-l-accent">
                <span className="material-symbols-outlined text-6xl text-accent mb-4">menu_book</span>
                <h2 className="text-4xl md:text-6xl text-text-main font-calligraphy mb-6 leading-tight">{slide.title}</h2>
                <div className="grid grid-cols-2 gap-8 text-left max-w-2xl mx-auto bg-black/20 p-6 rounded-lg">
                    <div><div className="text-xs text-text-muted uppercase tracking-widest">Penceramah</div><div className="text-xl md:text-2xl font-bold text-accent">{slide.ustadz}</div></div>
                    <div><div className="text-xs text-text-muted uppercase tracking-widest">Waktu</div><div className="text-xl md:text-2xl font-bold text-text-main">{slide.date}</div></div>
                </div>
                {slide.description && <p className="mt-6 text-xl text-text-muted italic">"{slide.description}"</p>}
            </div>
        ));

        const FinancialSlide = memo(({ financials }) => (
            <div className="glass-panel p-10 rounded-xl text-center animate-fade-in w-full max-w-4xl mx-auto border-l-4 border-l-accent">
                <h2 className="text-4xl text-accent font-calligraphy mb-10">Laporan Keuangan Masjid</h2>
                <div className="grid grid-cols-3 gap-6">
                    <div className="bg-black/30 p-6 rounded-xl border border-white/5"><div className="text-emerald-400 mb-2"><span className="material-symbols-outlined text-4xl">arrow_circle_up</span></div><div className="text-xs uppercase text-text-muted mb-1">Pemasukan</div><div className="text-2xl font-bold text-text-main">{formatRupiah(financials.income)}</div></div>
                    <div className="bg-black/30 p-6 rounded-xl border border-white/5"><div className="text-red-400 mb-2"><span className="material-symbols-outlined text-4xl">arrow_circle_down</span></div><div className="text-xs uppercase text-text-muted mb-1">Pengeluaran</div><div className="text-2xl font-bold text-text-main">{formatRupiah(financials.expense)}</div></div>
                    <div className="bg-accent/20 p-6 rounded-xl border border-accent/30 scale-110 shadow-lg"><div className="text-accent mb-2"><span className="material-symbols-outlined text-4xl">account_balance</span></div><div className="text-xs uppercase text-accent font-bold mb-1">Saldo Akhir</div><div className="text-3xl font-bold text-text-main">{formatRupiah(financials.balance)}</div></div>
                </div>
                <div className="mt-8 text-sm text-text-muted">Data per tanggal {new Date().toLocaleDateString('id-ID')}</div>
            </div>
        ));

        const PrayerCard = memo(({name, time, active, layout, status}) => {
            const isIqamah = active && status === 'iqamah';
            return (
                <div className={`relative overflow-hidden transition-all duration-500
                    ${layout === 'simple' ? 'flex justify-between items-center p-4 border-b border-white/10' : 
                      layout === 'modern' ? 'flex flex-col items-center justify-center p-2 rounded-xl border border-white/10 bg-black/20' :
                      'flex flex-col items-center justify-center pt-6 pb-2 rounded-t-[50px] border border-accent/20 bg-surface-dark'}
                    ${active ? (isIqamah ? 'bg-red-900/40 border-red-500 scale-105 z-10' : 'bg-accent/10 border-accent scale-105 z-10') : ''}
                `}>
                    <span className={`uppercase font-bold ${layout==='simple'?'text-xl':'text-xs tracking-widest'} ${active?(isIqamah?'text-red-400':'text-accent'):'text-text-muted'}`}>{name}</span>
                    <span className={`font-display font-bold ${layout==='simple'?'text-2xl':'text-2xl md:text-3xl'} ${active?'text-text-main text-shadow-glow':'text-text-main'}`}>{time}</span>
                    {isIqamah && <span className="text-[10px] text-red-400 animate-pulse mt-1 font-bold">IQOMAH</span>}
                    {active && !isIqamah && layout !== 'simple' && <div className="mt-2 w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></div>}
                </div>
            );
        });

        const RunningText = memo(({texts}) => (
            <div className="fixed bottom-0 w-full h-12 bg-surface-dark border-t border-accent/30 backdrop-blur-md flex z-50">
                <div className="bg-accent text-background-dark px-6 flex items-center font-bold tracking-widest uppercase text-xs">Info</div>
                <div className="flex-1 overflow-hidden relative flex items-center">
                    <div className="whitespace-nowrap absolute animate-marquee flex gap-16">
                        {[...texts, ...texts].map((t,i) => <span key={i} className="text-lg font-calligraphy text-text-main"><span className="text-accent mx-2">◆</span>{t}</span>)}
                    </div>
                </div>
            </div>
        ));

        // --- DASHBOARD LAYOUTS ---
        const Dashboard = () => {
            const { settings, todaysTimings, hijriDate, isOnline } = useContext(SettingsContext);
            const [slideIdx, setSlideIdx] = useState(-1);
            const [nextP, setNextP] = useState(null); // { name, time, targetDate, status }
            const [timeDiff, setTimeDiff] = useState(0);
            const [hasInteracted, setHasInteracted] = useState(false);
            const adhanAudio = useRef(new Audio(BEEP_AUDIO_BASE64));
            const iqamahAudio = useRef(new Audio(BEEP_AUDIO_BASE64));

            const handleStart = () => {
                setHasInteracted(true);
                adhanAudio.current.volume = 0;
                adhanAudio.current.play().catch(e=>console.log(e));
            };

            // LOGIC UTAMA: Next Prayer & Countdown
            useEffect(() => {
                if(!todaysTimings) return;
                const calculate = () => {
                    const now = new Date();
                    const order = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                    let found = null;
                    let target = new Date();
                    let status = 'adhan';
                    let prayerDuration = settings.general.prayerDuration || 10;
                    const isFriday = now.getDay() === 5;

                    for (let name of order) {
                        const timeStr = todaysTimings[name];
                        if(!timeStr) continue;
                        const [h,m] = timeStr.split(':').map(Number);
                        const pTime = new Date(); pTime.setHours(h,m,0,0);
                        
                        if (isFriday && name === 'Dhuhr') prayerDuration = settings.general.fridayPrayerDuration || 30;
                        else prayerDuration = settings.general.prayerDuration || 10;

                        const iqamahTime = new Date(pTime.getTime() + (settings.general.iqamahDelay||10)*60000);
                        const endPrayerTime = new Date(iqamahTime.getTime() + prayerDuration*60000);

                        // Trigger Audio (approx match within 1s)
                        if (hasInteracted && !settings.audio.isMuted && name !== 'Sunrise') {
                            if (Math.abs(now - pTime) < 1000) { adhanAudio.current.volume=1; adhanAudio.current.play(); }
                            if (Math.abs(now - iqamahTime) < 1000) { iqamahAudio.current.volume=1; iqamahAudio.current.play(); }
                        }

                        if (now < pTime) { found={name,time:timeStr}; target=pTime; status='adhan'; break; }
                        else if (now < iqamahTime && name !== 'Sunrise') { found={name,time:timeStr}; target=iqamahTime; status='iqamah'; break; }
                        else if (now < endPrayerTime && name !== 'Sunrise') { found={name,time:timeStr}; target=endPrayerTime; status='prayer'; break; }
                    }

                    if (!found) {
                        // Next is Fajr tomorrow
                        found = { name: 'Fajr', time: todaysTimings['Fajr'] };
                        const [h,m] = found.time.split(':').map(Number);
                        target = new Date(); target.setDate(target.getDate()+1); target.setHours(h,m,0,0);
                        status = 'adhan';
                    }

                    setNextP({...found, targetDate: target, status});
                    setTimeDiff(target - now);
                };

                calculate();
                const timer = setInterval(calculate, 1000);
                return () => clearInterval(timer);
            }, [todaysTimings, hasInteracted, settings]);

            useEffect(() => {
                const slides = settings.slides || [];
                const dur = slideIdx === -1 ? 30000 : ((slides[slideIdx] && slides[slideIdx].duration) || 10) * 1000;
                const t = setTimeout(() => {
                    setSlideIdx(p => {
                        // Force back to clock if iqamah/prayer
                        if(nextP && (nextP.status === 'iqamah' || nextP.status === 'prayer')) return -1;
                        if (slides.length === 0) return -1;
                        
                        let nextIdx = p + 1;
                        if (nextIdx >= slides.length) nextIdx = -1;

                        // Auto-skip online slides if offline
                        if (!isOnline && nextIdx !== -1) {
                            const nextSlide = slides[nextIdx];
                            if (nextSlide.fromDrive || nextSlide.type === 'video') {
                                // If returning to clock is safer, do that
                                return -1; 
                            }
                        }
                        
                        return nextIdx;
                    });
                }, dur);
                return () => clearTimeout(t);
            }, [slideIdx, settings.slides, nextP, isOnline]);

            const prayers = [{id:'Fajr',name:'Subuh',arab:'الفجر'},{id:'Sunrise',name:'Syuruq',arab:'الشروق'},{id:'Dhuhr',name:'Dzuhur',arab:'الظهر'},{id:'Asr',name:'Ashar',arab:'العصر'},{id:'Maghrib',name:'Maghrib',arab:'المغرب'},{id:'Isha',name:'Isya',arab:'العشاء'}];

            const renderCenter = () => {
                // If Prayer Mode, Show Full Screen Overlay
                if(nextP && nextP.status === 'prayer') {
                    return (
                        <div className="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center animate-fade-in text-center">
                            <h1 className="text-6xl text-accent font-bold mb-4">SHOLAT {nextP.name.toUpperCase()}</h1>
                            <p className="text-2xl text-white animate-pulse">Luruskan dan Rapatkan Shaf</p>
                        </div>
                    );
                }

                if(slideIdx !== -1 && settings.slides[slideIdx]) {
                    const s = settings.slides[slideIdx];
                    
                    // Fallback visual for offline broken images
                    if (!isOnline && s.fromDrive) {
                        return <div className="flex flex-col items-center justify-center h-full text-white/30"><span className="material-symbols-outlined text-6xl mb-4">wifi_off</span><p>Mode Offline: Gambar tidak tersedia</p></div>;
                    }

                    if(s.type === 'image') return <img src={s.url} onError={(e)=>{e.target.style.display='none'}} className="max-h-full max-w-full object-contain rounded-xl shadow-2xl animate-fade-in border border-accent/20"/>;
                    if(s.type === 'video') return (
                        <div className="w-full h-full flex items-center justify-center animate-fade-in p-4">
                            <video src={s.url} autoPlay muted loop className="max-h-full max-w-full rounded-2xl shadow-2xl border border-accent/20" />
                        </div>
                    );
                    if(s.type === 'kajian') return <KajianSlide slide={s} />;
                    if(s.type === 'financial') return <FinancialSlide financials={settings.financials} />;
                }
                return <ClockWidget nextPrayer={nextP} status={nextP && nextP.status} timeDiff={timeDiff} />;
            };

            const tmpl = settings.general.template;

            return (
                <div className="relative h-screen w-full overflow-hidden bg-background-dark text-text-main flex flex-col">
                    {!hasInteracted && <StartOverlay onStart={handleStart} />}
                    <div className="absolute inset-0 z-0">
                        <div className="absolute inset-0 bg-cover bg-center transition-all duration-1000" style={{backgroundImage:`url("${settings.appearance.bgImage}")`}}></div>
                        <div className="absolute inset-0 bg-background-dark/70"></div>
                        <div className="absolute inset-0 islamic-pattern opacity-30"></div>
                    </div>
                    <div className="relative z-10 flex-1 flex flex-col p-6 pb-16">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <div className="text-accent font-quran text-xl mb-1">{hijriDate}</div>
                                <h1 className="text-4xl md:text-5xl font-calligraphy text-text-main drop-shadow-md">{settings.general.mosqueName}</h1>
                                <div className="flex items-center gap-2 text-text-muted text-sm mt-1">
                                    <span className="material-symbols-outlined text-sm">location_on</span>{settings.location.city}
                                    {!isOnline && <span className="bg-red-600 text-white text-[10px] px-2 py-0.5 rounded ml-2 font-bold animate-pulse">OFFLINE MODE</span>}
                                </div>
                            </div>
                            {tmpl !== 'simple' && <div className="hidden md:block font-quran text-3xl text-accent opacity-80">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيم</div>}
                        </div>
                        <div className="flex-1 flex gap-6 min-h-0">
                            {tmpl === 'simple' ? (
                                <React.Fragment><div className="flex-1 flex items-center justify-center">{renderCenter()}</div><div className="w-1/3 flex flex-col justify-center bg-black/20 rounded-xl p-4 border border-white/5">{prayers.map(p => <PrayerCard key={p.id} name={p.name} time={todaysTimings && todaysTimings[p.id]} active={nextP && (nextP.name === p.id || (nextP.name==='Fajr' && p.id==='Subuh') || (nextP.name==='Sunrise' && p.id==='Syuruq'))} status={nextP && nextP.status} layout="simple"/>)}</div></React.Fragment>
                            ) : tmpl === 'modern' ? (
                                <div className="flex flex-col w-full h-full gap-6"><div className="grid grid-cols-6 gap-2">{prayers.map(p => <PrayerCard key={p.id} name={p.name} time={todaysTimings && todaysTimings[p.id]} active={nextP && nextP.name === p.id} status={nextP && nextP.status} layout="modern"/>)}</div><div className="flex-1 flex items-center justify-center relative">{renderCenter()}</div><div className="grid grid-cols-3 gap-4 h-24"><div className="glass-panel p-4 rounded-xl flex items-center gap-3"><span className="material-symbols-outlined text-3xl text-accent">mosque</span><div><div className="text-xs text-text-muted">Imam</div><div className="font-bold">{settings.fridayInfo.imam}</div></div></div><div className="glass-panel p-4 rounded-xl flex items-center gap-3"><span className="material-symbols-outlined text-3xl text-accent">mic</span><div><div className="text-xs text-text-muted">Khatib</div><div className="font-bold">{settings.fridayInfo.khatib}</div></div></div><div className="glass-panel p-4 rounded-xl flex items-center gap-3"><span className="material-symbols-outlined text-3xl text-accent">account_balance_wallet</span><div><div className="text-xs text-text-muted">Saldo</div><div className="font-bold">{formatRupiah(settings.financials.balance)}</div></div></div></div></div>
                            ) : (
                                <div className="flex flex-col w-full h-full justify-between"><div className="flex-1 flex items-center justify-center">{renderCenter()}</div><div className="mt-8 grid grid-cols-6 gap-3">{prayers.map(p => <PrayerCard key={p.id} name={p.name} arabicName={p.arab} time={todaysTimings && todaysTimings[p.id]} active={nextP && nextP.name === p.id} status={nextP && nextP.status} layout="classic"/>)}</div></div>
                            )}
                        </div>
                    </div>
                    <RunningText texts={settings.runningText.texts} />
                    <Link to="/settings" className="fixed top-4 right-4 z-50 p-2 text-white/10 hover:text-accent transition-colors"><span className="material-symbols-outlined">settings</span></Link>
                </div>
            );
        };

        // --- SETTINGS ---
        const SettingsPage = () => {
            const navigate = useNavigate();
            const { settings, updateSettings, handleFileUpload, setSettings, user, db, appId, firebaseAvailable } = useContext(SettingsContext);
            const [newTxt, setNewTxt] = useState("");
            const [stats, setStats] = useState({count:0, locs:[]});
            const [isLoadingLoc, setIsLoadingLoc] = useState(false);
            const [searchQuery, setSearchQuery] = useState("");
            const [searchStatus, setSearchStatus] = useState("");
            const [isFetchingDrive, setIsFetchingDrive] = useState(false);
            const [driveMsg, setDriveMsg] = useState("");
            const slideFileRef = useRef(null);
            const videoFileRef = useRef(null);
            const bgFileRef = useRef(null);

            useEffect(() => {
                if(firebaseAvailable && user && db) {
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('visits').get().then(s => {
                        const count = s.size;
                        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('locations').orderBy('timestamp','desc').limit(5).get().then(l => {
                            setStats({count, locs: l.docs.map(d=>d.data())});
                        }).catch(err => console.warn("Failed to load locations:", err));
                    }).catch(err => console.warn("Failed to load visits:", err));
                }
            }, [user]);
            
            const handleGPS = () => {
                setIsLoadingLoc(true);
                navigator.geolocation.getCurrentPosition(async pos => {
                    updateSettings('location','lat',pos.coords.latitude);
                    updateSettings('location','lng',pos.coords.longitude);
                    try {
                        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                        const d = await r.json();
                        updateSettings('location','city', d.address.city||d.address.town||"Lokasi GPS");
                    } catch(e){}
                    setIsLoadingLoc(false);
                }, () => setIsLoadingLoc(false));
            };

            const handleManualSearch = async () => {
                if (!searchQuery) return;
                setIsLoadingLoc(true);
                setSearchStatus("Mencari...");
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const place = data[0];
                        updateSettings('location', 'lat', parseFloat(place.lat));
                        updateSettings('location', 'lng', parseFloat(place.lon));
                        updateSettings('location', 'city', place.display_name.split(',')[0]);
                        setSearchStatus("Ditemukan!");
                        setTimeout(() => setSearchStatus(""), 3000);
                    } else {
                        setSearchStatus("Tidak ditemukan.");
                    }
                } catch (error) {
                    setSearchStatus("Error koneksi.");
                } finally {
                    setIsLoadingLoc(false);
                }
            };

            const fetchFromDrive = async () => {
                if (!settings.drive || !settings.drive.apiKey) {
                    setDriveMsg("Error: API Key Kosong. Harap masukkan Google API Key.");
                    return;
                }
                const match = (settings.drive && settings.drive.folderUrl) ? settings.drive.folderUrl.match(/[-\w]{25,}/) : null;
                if (!match) {
                    setDriveMsg("Error: Link Folder tidak valid.");
                    return;
                }
                const folderId = match[0];
                setIsFetchingDrive(true);
                setDriveMsg("Menghubungkan ke Google Drive...");

                try {
                    // Query yang lebih aman dengan encodeURIComponent
                    const q = encodeURIComponent(`'${folderId}' in parents and trashed = false and (mimeType contains 'image/' or mimeType contains 'video/')`);
                    const fields = encodeURIComponent("files(id,name,mimeType,thumbnailLink,webContentLink)");
                    const url = `https://www.googleapis.com/drive/v3/files?q=${q}&key=${settings.drive.apiKey}&fields=${fields}&orderBy=name`;

                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        const errData = await response.json();
                        const errMsg = (errData.error && errData.error.message) || "Gagal akses API.";
                        
                        if (errMsg.includes("referer") || errMsg.includes("blocked")) {
                            throw new Error("API Key dibatasi (Referer Blocked). Harap set 'Application restrictions' ke 'None' di Google Cloud Console.");
                        }
                        
                        throw new Error(errMsg);
                    }
                    
                    const data = await response.json();
                    if (!data.files || data.files.length === 0) {
                        setDriveMsg("Folder ditemukan tapi kosong (atau tidak ada gambar/video publik).");
                        setIsFetchingDrive(false);
                        return;
                    }

                    const newSlides = data.files.map(f => {
                        // Trik: Gunakan thumbnailLink resolusi tinggi agar tidak kena limit CORS webContentLink
                        // ganti =s220 menjadi =s1920 (Full HD)
                        let mediaUrl = f.webContentLink;
                        if (f.mimeType.startsWith('image/') && f.thumbnailLink) {
                            mediaUrl = f.thumbnailLink.replace(/=s\d+$/, '=s1920'); 
                        }
                        
                        return {
                            type: f.mimeType.startsWith('image/') ? 'image' : 'video',
                            url: mediaUrl,
                            duration: 15,
                            fromDrive: true,
                            title: f.name // Opsional: simpan nama file
                        };
                    });

                    setSettings(p => {
                        // Hapus slide drive lama agar tidak duplikat saat fetch ulang
                        const cleanSlides = (p.slides || []).filter(s => !s.fromDrive);
                        return {
                            ...p,
                            slides: [...cleanSlides, ...newSlides]
                        };
                    });
                    setDriveMsg(`Sukses! ${newSlides.length} file berhasil ditambahkan.`);
                } catch (error) {
                    console.error("Drive Error:", error);
                    setDriveMsg("Gagal: " + error.message);
                } finally {
                    setIsFetchingDrive(false);
                }
            };

            const addSlide = (type) => {
                if(type === 'kajian') setSettings(p => ({...p, slides: [...(p.slides||[]), {type:'kajian', title:'Judul Kajian', ustadz:'Nama Ustadz', date:'Waktu', description:'', duration:15}]}));
                if(type === 'financial') setSettings(p => ({...p, slides: [...(p.slides||[]), {type:'financial', duration:15}]}));
            };

            const updateSlide = (index, field, value) => {
                const newSlides = [...settings.slides];
                newSlides[index][field] = value;
                setSettings(p => ({...p, slides: newSlides}));
            };

            const removeSlide = (index) => {
                const newSlides = settings.slides.filter((_, i) => i !== index);
                setSettings(prev => ({ ...prev, slides: newSlides })); 
            };

            const THEMES = [
                {id:'royal-gold',name:'Royal Gold',color:'#D4AF37'},{id:'emerald',name:'Emerald',color:'#10b981'},
                {id:'ocean',name:'Ocean',color:'#38bdf8'},{id:'sunset',name:'Sunset',color:'#f97316'},
                {id:'amethyst',name:'Amethyst',color:'#a855f7'},{id:'midnight',name:'Midnight',color:'#6366f1'},
                {id:'earth',name:'Earth',color:'#84cc16'}
            ];

            return (
                <div className="h-screen bg-background-dark text-text-main flex flex-col font-display overflow-hidden">
                    <div className="p-4 border-b border-accent/20 flex justify-between items-center bg-surface-dark">
                        <h2 className="text-xl font-bold text-accent">Pengaturan Dashboard</h2>
                        <button onClick={()=>navigate('/')} className="px-4 py-2 bg-accent text-background-dark font-bold rounded hover:bg-white">Simpan</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6">
                        <div className="max-w-4xl mx-auto space-y-6">
                            
                            {/* LAYOUT & THEME */}
                            <section className="glass-panel p-6 rounded-xl border-l-4 border-accent">
                                <h3 className="text-lg font-bold text-accent mb-4">Tampilan</h3>
                                <div className="space-y-4">
                                    <div><label className="text-sm text-text-muted block mb-1">Layout</label><div className="flex gap-2">{['classic','modern','simple'].map(l => (<button key={l} onClick={()=>updateSettings('general','template',l)} className={`flex-1 py-2 rounded border ${settings.general.template===l?'bg-accent text-black border-accent':'border-white/10'}`}>{l.toUpperCase()}</button>))}</div></div>
                                    <div><label className="text-sm text-text-muted block mb-1">Tema Warna</label><div className="grid grid-cols-4 gap-2">{THEMES.map(t => (<button key={t.id} onClick={()=>updateSettings('appearance','theme',t.id)} className={`py-2 rounded border flex items-center justify-center gap-2 ${settings.appearance.theme===t.id?'bg-white/10 border-accent':'border-white/10'}`}><div className="w-3 h-3 rounded-full" style={{background:t.color}}></div><span className="text-xs">{t.name}</span></button>))}</div></div>
                                    <div className="cursor-pointer border-dashed border-2 border-white/20 p-4 rounded text-center hover:border-accent" onClick={()=>bgFileRef.current.click()}>Upload Background Baru<input type="file" ref={bgFileRef} className="hidden" onChange={e=>handleFileUpload(e.target.files[0],'bg')}/></div>
                                </div>
                            </section>

                            {/* SLIDESHOW */}
                            <section className="glass-panel p-6 rounded-xl border-l-4 border-accent">
                                <h3 className="text-lg font-bold text-accent mb-4">Konten Slide</h3>
                                <div className="flex gap-2 mb-4 flex-wrap">
                                    <button onClick={()=>slideFileRef.current.click()} className="flex-1 py-2 bg-white/5 hover:bg-white/10 border border-white/20 rounded">+ Gambar</button>
                                    <button onClick={()=>videoFileRef.current.click()} className="flex-1 py-2 bg-white/5 hover:bg-white/10 border border-white/20 rounded">+ Video</button>
                                    <button onClick={()=>addSlide('kajian')} className="flex-1 py-2 bg-white/5 hover:bg-white/10 border border-white/20 rounded">+ Info Kajian</button>
                                    <button onClick={()=>addSlide('financial')} className="flex-1 py-2 bg-white/5 hover:bg-white/10 border border-white/20 rounded">+ Laporan Keuangan</button>
                                    <input type="file" ref={slideFileRef} className="hidden" accept="image/*" onChange={e=>handleFileUpload(e.target.files[0],'slide')}/>
                                    <input type="file" ref={videoFileRef} className="hidden" accept="video/*" onChange={e=>handleFileUpload(e.target.files[0],'video')}/>
                                </div>

                                {/* GOOGLE DRIVE INTEGRATION PANEL */}
                                <div className="bg-black/30 border border-accent/30 rounded p-4 mb-4">
                                    <h4 className="text-sm font-bold text-accent mb-2 flex items-center gap-2"><span className="material-symbols-outlined">cloud_download</span> Integrasi Google Drive</h4>
                                    <div className="space-y-2 text-xs">
                                        <div>
                                            <label className="text-text-muted block mb-1">Google API Key (Wajib)</label>
                                            <input className="w-full bg-black/30 border border-white/10 rounded px-2 py-1" placeholder="AIzaSy..." value={(settings.drive && settings.drive.apiKey) || ""} onChange={e=>updateSettings('drive','apiKey',e.target.value)} />
                                            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" className="text-[10px] text-accent hover:underline">Buat API Key di sini (Aktifkan Drive API)</a>
                                        </div>
                                        <div>
                                            <label className="text-text-muted block mb-1">Link Folder Google Drive</label>
                                            <input className="w-full bg-black/30 border border-white/10 rounded px-2 py-1" value={(settings.drive && settings.drive.folderUrl) || ""} onChange={e=>updateSettings('drive','folderUrl',e.target.value)} />
                                        </div>
                                        <button onClick={fetchFromDrive} disabled={isFetchingDrive} className={`w-full py-2 rounded font-bold transition-all ${isFetchingDrive ? 'bg-white/10 text-white/50' : 'bg-accent text-black hover:bg-white'}`}>
                                            {isFetchingDrive ? 'Sedang Mengambil...' : 'Tarik Data dari Drive'}
                                        </button>
                                        {driveMsg && <div className={`text-xs p-2 rounded ${driveMsg.includes('Error') || driveMsg.includes('Gagal') ? 'bg-red-900/50 text-red-200' : 'bg-green-900/50 text-green-200'}`}>{driveMsg}</div>}
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    {(settings.slides||[]).map((s,i) => (
                                        <div key={i} className="flex flex-col justify-between bg-black/20 p-3 rounded gap-2">
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-sm font-bold text-accent">{s.type.toUpperCase()}</span>
                                                    {s.fromDrive && <span className="text-[10px] bg-blue-900 px-1 rounded text-blue-200">DRIVE</span>}
                                                </div>
                                                <button onClick={() => removeSlide(i)} className="text-red-400 text-xs hover:text-red-300">Hapus</button>
                                            </div>
                                            
                                            {/* KAJIAN EDITORS */}
                                            {s.type === 'kajian' && (
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                                                    <input className="bg-black/30 border border-white/10 rounded px-2 py-1 text-text-main" placeholder="Judul Kajian" value={s.title} onChange={(e)=>updateSlide(i, 'title', e.target.value)} />
                                                    <input className="bg-black/30 border border-white/10 rounded px-2 py-1 text-text-main" placeholder="Nama Ustadz" value={s.ustadz} onChange={(e)=>updateSlide(i, 'ustadz', e.target.value)} />
                                                    <input className="bg-black/30 border border-white/10 rounded px-2 py-1 text-text-main" placeholder="Waktu Pelaksanaan" value={s.date} onChange={(e)=>updateSlide(i, 'date', e.target.value)} />
                                                    <input className="bg-black/30 border border-white/10 rounded px-2 py-1 text-text-main" placeholder="Deskripsi Singkat" value={s.description} onChange={(e)=>updateSlide(i, 'description', e.target.value)} />
                                                </div>
                                            )}

                                            <div className="flex items-center gap-2 mt-1">
                                                 <label className="text-xs text-text-muted">Durasi (detik):</label>
                                                 <input type="number" className="w-16 bg-black/30 border border-white/10 rounded px-2 py-1 text-xs text-text-main" value={s.duration||10} onChange={(e)=>updateSlide(i, 'duration', parseInt(e.target.value))} />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </section>

                            {/* DATA SETTINGS */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <section className="glass-panel p-6 rounded-xl border-l-4 border-accent">
                                    <h3 className="text-lg font-bold text-accent mb-4">Umum & Lokasi</h3>
                                    <div className="space-y-3">
                                        <input className="w-full bg-black/20 border border-white/10 rounded p-2 text-text-main" placeholder="Nama Masjid" value={settings.general.mosqueName} onChange={e=>updateSettings('general','mosqueName',e.target.value)}/>
                                        
                                        {/* LOCATION & GPS INPUTS */}
                                        <div className="bg-black/20 p-3 rounded border border-white/10 space-y-2">
                                            <div className="flex gap-2">
                                                <input className="flex-1 bg-black/30 border border-white/10 rounded px-2 text-text-main text-sm" placeholder="Cari Kota..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleManualSearch()}/>
                                                <button onClick={handleManualSearch} disabled={isLoadingLoc} className="bg-white/10 px-2 rounded text-accent"><span className="material-symbols-outlined text-sm">search</span></button>
                                                <button onClick={handleGPS} disabled={isLoadingLoc} className="bg-white/10 px-2 rounded text-accent"><span className="material-symbols-outlined text-sm">my_location</span></button>
                                            </div>
                                            {searchStatus && <div className="text-xs text-accent">{searchStatus}</div>}
                                            <div className="grid grid-cols-2 gap-2">
                                                <label className="text-xs text-text-muted">Lat<input className="w-full bg-black/30 border border-white/10 rounded px-2 py-1 text-text-main" value={settings.location.lat} onChange={e=>updateSettings('location','lat',e.target.value)}/></label>
                                                <label className="text-xs text-text-muted">Lng<input className="w-full bg-black/30 border border-white/10 rounded px-2 py-1 text-text-main" value={settings.location.lng} onChange={e=>updateSettings('location','lng',e.target.value)}/></label>
                                            </div>
                                            <label className="text-xs text-text-muted block">Nama Kota (Tampil)<input className="w-full bg-black/30 border border-white/10 rounded px-2 py-1 text-text-main mt-1" value={settings.location.city} onChange={e=>updateSettings('location','city',e.target.value)}/></label>
                                        </div>

                                        <label className="text-xs text-text-muted block">Metode Hitung
                                            <select className="w-full bg-black/20 border border-white/10 rounded p-2 mt-1 text-text-main" value={settings.general.method} onChange={e=>updateSettings('general','method',e.target.value)}>
                                                <option value="20">Kemenag RI (Standard)</option>
                                                <option value="muhammadiyah">Muhammadiyah</option>
                                                <option value="1">Egyptian (General)</option>
                                            </select>
                                        </label>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-xs text-text-muted block mb-1">Jeda Iqomah (Menit)</label>
                                                <input type="number" className="w-full bg-black/20 border border-white/10 rounded p-2" value={settings.general.iqamahDelay} onChange={e=>updateSettings('general','iqamahDelay',e.target.value)}/>
                                                <p className="text-[10px] text-slate-400 mt-1 leading-tight">Waktu tunggu dari Adzan ke Iqomah.</p>
                                            </div>
                                            <div>
                                                <label className="text-xs text-text-muted block mb-1">Koreksi Hijriah (Hari)</label>
                                                <input type="number" className="w-full bg-black/20 border border-white/10 rounded p-2" value={settings.general.hijriAdjustment} onChange={e=>updateSettings('general','hijriAdjustment',parseInt(e.target.value)||0)}/>
                                                <p className="text-[10px] text-slate-400 mt-1 leading-tight">Isi 1 atau -1 jika tanggal Hijriah selisih.</p>
                                            </div>
                                            <div>
                                                <label className="text-xs text-text-muted block mb-1">Durasi Sholat (Menit)</label>
                                                <input type="number" className="w-full bg-black/20 border border-white/10 rounded p-2" value={settings.general.prayerDuration} onChange={e=>updateSettings('general','prayerDuration',parseInt(e.target.value)||10)}/>
                                                <p className="text-[10px] text-slate-400 mt-1 leading-tight">Lama layar "Luruskan Shaf" tampil.</p>
                                            </div>
                                            <div>
                                                <label className="text-xs text-text-muted block mb-1">Durasi Jumat (Menit)</label>
                                                <input type="number" className="w-full bg-black/20 border border-white/10 rounded p-2" value={settings.general.fridayPrayerDuration} onChange={e=>updateSettings('general','fridayPrayerDuration',parseInt(e.target.value)||30)}/>
                                                <p className="text-[10px] text-slate-400 mt-1 leading-tight">Durasi khusus layar sholat saat Jumat.</p>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                                <section className="glass-panel p-6 rounded-xl border-l-4 border-accent">
                                    <h3 className="text-lg font-bold text-accent mb-4">Keuangan & Jumat</h3>
                                    
                                    <div className="grid grid-cols-1 gap-6">
                                        {/* Bagian Keuangan */}
                                        <div>
                                            <h4 className="text-sm font-bold text-accent mb-3 uppercase tracking-wider border-b border-white/10 pb-1">Laporan Kas</h4>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="text-xs text-text-muted block mb-1">Saldo Akhir (Rp)</label>
                                                    <input type="number" className="w-full bg-black/20 border border-white/10 rounded p-2 text-text-main" value={settings.financials.balance} onChange={e=>updateSettings('financials','balance',parseInt(e.target.value)||0)}/>
                                                    <p className="text-[10px] text-slate-400 mt-1">Total sisa uang kas saat ini.</p>
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-xs text-text-muted block mb-1">Pemasukan (Rp)</label>
                                                        <input type="number" className="w-full bg-black/20 border border-white/10 rounded p-2 text-text-main" value={settings.financials.income} onChange={e=>updateSettings('financials','income',parseInt(e.target.value)||0)}/>
                                                        <p className="text-[10px] text-slate-400 mt-1">Infaq masuk bulan/pekan ini.</p>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-text-muted block mb-1">Pengeluaran (Rp)</label>
                                                        <input type="number" className="w-full bg-black/20 border border-white/10 rounded p-2 text-text-main" value={settings.financials.expense} onChange={e=>updateSettings('financials','expense',parseInt(e.target.value)||0)}/>
                                                        <p className="text-[10px] text-slate-400 mt-1">Biaya keluar bulan/pekan ini.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Bagian Petugas Jumat */}
                                        <div>
                                            <h4 className="text-sm font-bold text-accent mb-3 uppercase tracking-wider border-b border-white/10 pb-1">Petugas Jumat Depan</h4>
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="text-xs text-text-muted block mb-1">Nama Khatib</label>
                                                    <input className="w-full bg-black/20 border border-white/10 rounded p-2 text-text-main" value={settings.fridayInfo.khatib} onChange={e=>updateSettings('fridayInfo','khatib',e.target.value)}/>
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-xs text-text-muted block mb-1">Nama Imam</label>
                                                        <input className="w-full bg-black/20 border border-white/10 rounded p-2 text-text-main" value={settings.fridayInfo.imam} onChange={e=>updateSettings('fridayInfo','imam',e.target.value)}/>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-text-muted block mb-1">Nama Muadzin</label>
                                                        <input className="w-full bg-black/20 border border-white/10 rounded p-2 text-text-main" value={settings.fridayInfo.muadzin} onChange={e=>updateSettings('fridayInfo','muadzin',e.target.value)}/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>

                            {/* RUNNING TEXT */}
                            <section className="glass-panel p-6 rounded-xl border-l-4 border-accent">
                                <h3 className="text-lg font-bold text-accent mb-4">Running Text</h3>
                                <div className="flex gap-2 mb-2"><input className="flex-1 bg-black/20 border border-white/10 rounded p-2" value={newTxt} onChange={e=>setNewTxt(e.target.value)} placeholder="Info Baru..."/><button onClick={()=>{updateSettings('runningText','texts',[...settings.runningText.texts, newTxt]); setNewTxt("");}} className="bg-accent text-black px-4 rounded">Tambah</button></div>
                                <div className="flex flex-col gap-1">
                                    {settings.runningText.texts.map((t,i)=>(<div key={i} className="flex justify-between bg-black/20 p-2 rounded"><span className="text-xs">{t}</span><button onClick={()=>updateSettings('runningText','texts',settings.runningText.texts.filter((_,x)=>x!==i))} className="text-red-400 text-xs">Hapus</button></div>))}
                                </div>
                            </section>

                        </div>
                    </div>
                </div>
            );
        };

        const App = () => (
            <SettingsProvider>
                <HashRouter>
                    <Routes>
                        <Route path="/" element={<Dashboard />} />
                        <Route path="/settings" element={<SettingsPage />} />
                    </Routes>
                </HashRouter>
            </SettingsProvider>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
