<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>MuslimPro & Prayer Dashboard</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&family=Cinzel:wght@400;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Firebase Dependencies -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: 'rgb(var(--color-primary) / <alpha-value>)',
                        secondary: 'rgb(var(--color-secondary) / <alpha-value>)',
                        accent: 'rgb(var(--color-accent) / <alpha-value>)',
                        "background-dark": "#0f172a", 
                        "surface-dark": "rgb(var(--color-surface) / 0.8)",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"],
                        "arabic": ["Amiri", "serif"],
                        "serif": ["Cinzel", "serif"],
                        "modern": ["Inter", "sans-serif"],
                    },
                    backgroundImage: {
                        'islamic-pattern': "url('https://www.transparenttextures.com/patterns/arabesque.png')",
                    },
                    animation: {
                        'marquee': 'marquee 25s linear infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #020617;
            color: white;
        }
        
        /* --- THEME VARIABLES --- */
        :root {
            /* Default: Emerald (Hijau Masjid) */
            --color-primary: 16 185 129;   
            --color-secondary: 6 95 70;    
            --color-accent: 251 191 36;    
            --color-surface: 2 44 34;      
        }

        body.theme-ocean {
            --color-primary: 14 165 233;   
            --color-secondary: 12 74 110;  
            --color-accent: 56 189 248;    
            --color-surface: 8 47 73;      
        }

        body.theme-sunset {
            --color-primary: 249 115 22;   
            --color-secondary: 124 45 18;  
            --color-accent: 253 186 116;   
            --color-surface: 67 20 7;      
        }

        body.theme-amethyst {
            --color-primary: 168 85 247;   
            --color-secondary: 88 28 135;  
            --color-accent: 232 121 249;   
            --color-surface: 59 7 100;     
        }
        
        body.theme-midnight {
            --color-primary: 99 102 241;   /* Indigo */
            --color-secondary: 30 27 75;   /* Deep Indigo */
            --color-accent: 226 232 240;   /* Silver */
            --color-surface: 15 23 42;     /* Slate 900 */
        }

        body.theme-earth {
            --color-primary: 132 204 22;   /* Lime */
            --color-secondary: 63 98 18;   /* Olive */
            --color-accent: 234 179 8;     /* Yellow */
            --color-surface: 20 83 45;     /* Green 900 */
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgb(var(--color-secondary)); 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgb(var(--color-primary)); 
        }
        .compass-dial {
            transition: transform 0.5s cubic-bezier(0.4, 2, 0.55, 0.44);
        }
        .glass-panel {
            background: rgba(var(--color-surface), 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(var(--color-accent), 0.2);
        }
        .text-shadow-accent {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3), 0 0 2px rgba(var(--color-accent), 0.5);
        }
        /* Arch Shape for Classic Template */
        .arch-shape {
            mask-image: radial-gradient(circle at 50% 120%, transparent 40%, black 41%);
            -webkit-mask-image: radial-gradient(circle at 50% 120%, transparent 40%, black 41%);
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="bg-background-dark text-slate-100 transition-colors duration-500 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, memo, useMemo, createContext, useContext, useRef } = React;
        const { createRoot } = ReactDOM;
        const { HashRouter, Routes, Route, Link, useNavigate } = ReactRouterDOM;

        // --- SAFE FIREBASE SETUP ---
        let app = null;
        let auth = null;
        let db = null;
        let appId = 'default-app-id';
        let firebaseAvailable = false;

        try {
            // Check global variable from environment
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                firebaseAvailable = true;
            } else {
                 console.warn("Firebase config not found. Running in offline mode.");
            }
        } catch (e) {
            console.warn("Firebase initialization failed. Running in offline mode.", e);
        }

        // --- CONSTANTS ---
        const ISLAMIC_EVENTS_2025 = [
            { name: "Isra Mi'raj", date: "2025-01-27", hijri: "27 Rajab 1446 H" },
            { name: "Nisfu Syaban", date: "2025-02-14", hijri: "15 Syaban 1446 H" },
            { name: "Awal Ramadhan", date: "2025-03-01", hijri: "1 Ramadhan 1446 H" },
            { name: "Nuzulul Quran", date: "2025-03-17", hijri: "17 Ramadhan 1446 H" },
            { name: "Idul Fitri", date: "2025-03-31", hijri: "1 Syawal 1446 H" },
            { name: "Arafah", date: "2025-06-05", hijri: "9 Dzulhijjah 1446 H" },
            { name: "Idul Adha", date: "2025-06-06", hijri: "10 Dzulhijjah 1446 H" },
            { name: "Tahun Baru Islam", date: "2025-06-26", hijri: "1 Muharram 1447 H" },
            { name: "Asyura", date: "2025-07-05", hijri: "10 Muharram 1447 H" },
            { name: "Maulid Nabi", date: "2025-09-04", hijri: "12 Rabiul Awal 1447 H" }
        ];

        const HADITH_COLLECTION = [
            { text: "Amalan yang paling dicintai oleh Allah adalah yang terus-menerus dilakukan walaupun sedikit.", source: "HR. Bukhari & Muslim" },
            { text: "Sebaik-baik kalian adalah orang yang belajar Al-Qur'an dan mengajarkannya.", source: "HR. Bukhari" },
            { text: "Senyummu di hadapan saudaramu adalah sedekah bagimu.", source: "HR. Tirmidzi" },
            { text: "Barangsiapa menempuh jalan untuk menuntut ilmu, Allah akan mudahkan baginya jalan menuju surga.", source: "HR. Muslim" },
            { text: "Tangan di atas lebih baik daripada tangan di bawah.", source: "HR. Bukhari & Muslim" },
            { text: "Kebersihan adalah sebagian dari iman.", source: "HR. Muslim" },
            { text: "Tidak akan masuk surga orang yang memutuskan tali silaturahmi.", source: "HR. Bukhari & Muslim" },
            { text: "Barangsiapa yang beriman kepada Allah dan hari akhir, hendaklah ia berkata baik atau diam.", source: "HR. Bukhari & Muslim" },
            { text: "Shalat berjamaah lebih utama 27 derajat dibanding shalat sendirian.", source: "HR. Bukhari & Muslim" },
            { text: "Sesungguhnya setiap perbuatan tergantung niatnya.", source: "HR. Bukhari & Muslim" }
        ];

        // --- HELPERS ---
        const adjustTime = (timeStr, minutesToAdd) => {
            if (!timeStr) return "";
            const [h, m] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(h, m + (minutesToAdd || 0));
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        };

        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        // --- IMAGE COMPRESSION HELPER ---
        const compressImage = (file, maxWidth = 1024, quality = 0.6) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const elem = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }

                        elem.width = width;
                        elem.height = height;
                        const ctx = elem.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Convert to JPEG with reduced quality
                        resolve(ctx.canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // --- PRAYER ENGINE ---
        const PrayerCalc = {
            d2r: (d) => d * Math.PI / 180.0,
            r2d: (r) => r * 180.0 / Math.PI,
            fixHour: (a) => { a = a - 24.0 * Math.floor(a / 24.0); a = a < 0 ? a + 24.0 : a; return a; },
            sunPosition: (jd) => {
                const D = jd - 2451545.0;
                const g = PrayerCalc.fixHour(357.529 + 0.98560028 * D);
                const q = PrayerCalc.fixHour(280.459 + 0.98564736 * D);
                const L = PrayerCalc.fixHour(q + 1.915 * Math.sin(PrayerCalc.d2r(g)) + 0.020 * Math.sin(PrayerCalc.d2r(2 * g)));
                const R = 1.00014 - 0.01671 * Math.cos(PrayerCalc.d2r(g)) - 0.00014 * Math.cos(PrayerCalc.d2r(2 * g));
                const e = 23.439 - 0.00000036 * D;
                const RA = PrayerCalc.r2d(Math.atan2(Math.cos(PrayerCalc.d2r(e)) * Math.sin(PrayerCalc.d2r(L)), Math.cos(PrayerCalc.d2r(L)))) / 15.0;
                const RA_L = PrayerCalc.fixHour(L / 15.0);
                const RA_ = PrayerCalc.fixHour(RA);
                const RA_final = RA_ + (RA_L - RA_); 
                const Decl = PrayerCalc.r2d(Math.asin(Math.sin(PrayerCalc.d2r(e)) * Math.sin(PrayerCalc.d2r(L))));
                const EqT = q / 15.0 - RA_final;
                return { declination: Decl, equation: EqT };
            },
            getTimes: (date, lat, lng, timeZone, offsets = {}) => {
                let year = date.getFullYear(), month = date.getMonth() + 1, day = date.getDate();
                if (month <= 2) { year -= 1; month += 12; }
                const A = Math.floor(year / 100);
                const B = 2 - A + Math.floor(A / 4);
                const JD = Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + B - 1524.5;
                const sun = PrayerCalc.sunPosition(JD);
                const D = sun.declination;
                const EqT = sun.equation;
                const fajrAngle = 20; 
                const ishaAngle = 18;
                const computeTime = (angle, mode) => {
                   const P1 = -Math.sin(PrayerCalc.d2r(angle)) - Math.sin(PrayerCalc.d2r(lat)) * Math.sin(PrayerCalc.d2r(D));
                   const P2 = Math.cos(PrayerCalc.d2r(lat)) * Math.cos(PrayerCalc.d2r(D));
                   const V = Math.acos(P1 / P2) / 15.0;
                   return PrayerCalc.r2d(V); 
                };
                const dhuhr = 12 + EqT - lng / 15;
                const sunAngleTime = computeTime(0.833, 0); 
                const sunrise = dhuhr - sunAngleTime;
                const sunset = dhuhr + sunAngleTime;
                const fajrTime = computeTime(fajrAngle, 1);
                const ishaTime = computeTime(ishaAngle, 1);
                const fajr = dhuhr - fajrTime;
                const isha = dhuhr + ishaTime;
                const noonShadow = Math.abs(lat - D);
                const asrAngle = Math.atan(1 / (1 + Math.tan(PrayerCalc.d2r(noonShadow))));
                const asrTime = PrayerCalc.r2d(Math.acos((Math.sin(asrAngle) - Math.sin(PrayerCalc.d2r(lat)) * Math.sin(PrayerCalc.d2r(D))) / (Math.cos(PrayerCalc.d2r(lat)) * Math.cos(PrayerCalc.d2r(D))))) / 15.0;
                const asr = dhuhr + asrTime;
                const format = (t, correction = 0) => {
                    const time = PrayerCalc.fixHour(t + timeZone);
                    const hours = Math.floor(time);
                    const minutes = Math.floor((time - hours) * 60);
                    const d = new Date();
                    d.setHours(hours, minutes + correction, 0); 
                    return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                };
                return {
                    Fajr: format(fajr, offsets.Fajr),
                    Sunrise: format(sunrise, offsets.Sunrise),
                    Dhuhr: format(dhuhr, offsets.Dhuhr),
                    Asr: format(asr, offsets.Asr),
                    Maghrib: format(sunset, offsets.Maghrib),
                    Isha: format(isha, offsets.Isha)
                };
            }
        };

        const fetchPrayerTimesFromAPI = async (lat, lng, offsets) => {
            try {
                const response = await fetch(`https://api.aladhan.com/v1/timings/${Math.floor(Date.now() / 1000)}?latitude=${lat}&longitude=${lng}&method=20`); 
                if (!response.ok) throw new Error("Failed to fetch prayer times");
                const data = await response.json();
                const timings = data.data.timings;
                
                const correctedTimings = {
                    Fajr: adjustTime(timings.Fajr, offsets.Fajr),
                    Sunrise: adjustTime(timings.Sunrise, offsets.Sunrise),
                    Dhuhr: adjustTime(timings.Dhuhr, offsets.Dhuhr),
                    Asr: adjustTime(timings.Asr, offsets.Asr),
                    Maghrib: adjustTime(timings.Maghrib, offsets.Maghrib),
                    Isha: adjustTime(timings.Isha, offsets.Isha)
                };
                
                return { ...data.data, timings: correctedTimings }; 
            } catch (error) {
                console.error("API Error:", error);
                return null;
            }
        };

        // --- CONTEXT ---
        const SettingsContext = createContext();

        const defaultBg = "https://lh3.googleusercontent.com/aida-public/AB6AXuAOrQLKRUmFQhPxWSXwhFKntvqt5JvcRPZHSGEfJ6534s7zRxMYnhaVjiPPkQb1dSZerTsg6wuTZGGxx3ldiOsjAcwCPu5eXkl9Sh31aJykos91Vq4LS-XOvIdMt9-Lk2PEZSEb3Yy8MYY89dlvY-l8Bpgmn5aJs7P3TRtrwUCaytrFFcAo64P_Bl8hcaxQGUjEsNHbGrRYLfi8MNrFtYTDY-_FVk1V8cUKnIvDDK-pdMtl2WtaznRR5qWi3vmydcqQv2gcQj8jrVk";
        
        const slideshowImages = [
            defaultBg,
            "https://lh3.googleusercontent.com/aida-public/AB6AXuAIQlg9ExURoitbx-siETAk3sji_tYFU2RD2Wb3QHdPwd1H6L68cqmXzKWR48SuW5Q1TgJGbybsbWl77ODKERMY87uU11t43rTCxDRFLaaLxIUir7qXgGhdx1vRzV902TIJpEfXx1RcIX0zVXIdFXNiLLEZOafUijcZfxhvHebu9MTR6EPT6CCadKdhe1-er33j3KC7ryz7jTrysoFFBsT_XX5k4Ny-U6lVS5v63bPOkh4wK6p1Ix4_BXrPe-AwspexXFcJIaDQFHo",
            "https://lh3.googleusercontent.com/aida-public/AB6AXuB2LoTTl_o0k-4Xw86X_LRqqxQIicJpI1M_7AHxoPXjYwPEROPNoYl6t12YQuZKgb2YJFYswu81I8cZd7OmIRIRlQCn362IBxm6m--IkVU78Ndk1m7TSXg7veU9tbE49Um5uhUTf2rGHWHfBM5g19xmfd6tq9z3iE4kO9TUZCzJR4sKlL9t5agvMP6fAgbP2dV8q8thdKo3cReM04o95GiRAw5JhKgj1cWWMj6tFTxbtNBeBwDhpACJ_4Ne5MOe79ED9n1fH_b6YTw"
        ];

        const SettingsProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('muslimProSettings');
                return saved ? JSON.parse(saved) : {
                    general: {
                        mosqueName: "Masjid Al-Multazam",
                        theme: "emerald",
                        template: "classic", 
                        iqamahDelay: 10,
                        prayerDuration: 10, 
                        fridayPrayerDuration: 30, 
                        hijriAdjustment: 0 
                    },
                    location: { 
                        city: "Jakarta Pusat, DKI Jakarta", 
                        lat: -6.1754, 
                        lng: 106.8272,
                        manual: false 
                    },
                    offsets: { Fajr: 2, Sunrise: -2, Dhuhr: 2, Asr: 2, Maghrib: 2, Isha: 2 },
                    appearance: { bgImage: defaultBg, customBg: null, slideshowActive: false, slideshowInterval: 10, opacity: 70, blur: 4 },
                    runningText: { 
                        active: true, 
                        texts: ["Selamat datang di Masjid.", "Mohon nonaktifkan HP saat sholat berlangsung.", "Jagalah kebersihan masjid."], 
                        speed: 5, 
                        size: "medium" 
                    },
                    audio: { isMuted: true },
                    financials: { balance: 15000000, income: 4500000, expense: 1200000, lastUpdated: new Date().toISOString() },
                    fridayInfo: { khatib: "", imam: "", muadzin: "" },
                    slides: [{ type: 'clock', duration: 15 }, { type: 'financial', duration: 10 }]
                };
            });

            // Live Prayer Data
            const [todaysTimings, setTodaysTimings] = useState(null);
            const [hijriDate, setHijriDate] = useState("");

            useEffect(() => {
                if (firebaseAvailable && auth) {
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await auth.signInWithCustomToken(__initial_auth_token);
                            } else {
                                await auth.signInAnonymously();
                            }
                        } catch(e) {
                            console.log("Auth error", e);
                        }
                    };
                    initAuth();
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u);
                        if (u && db) {
                            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('visits').add({
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                uid: u.uid,
                                device: navigator.userAgent
                            }).catch(err => console.log("Tracking disabled offline"));
                        }
                    });
                    return () => unsubscribe();
                }
            }, []);

            useEffect(() => {
                try {
                    localStorage.setItem('muslimProSettings', JSON.stringify(settings));
                } catch (e) {
                    console.error("Local Storage Full:", e);
                    if (e.name === 'QuotaExceededError' || e.code === 22) {
                        alert("Penyimpanan Lokal Penuh! Gambar yang Anda masukkan terlalu besar. Pengaturan tidak tersimpan. Harap hapus beberapa slide atau gunakan gambar yang lebih kecil (kompres dulu).");
                    }
                }
                document.body.className = `bg-background-dark text-slate-100 transition-colors duration-500 overflow-x-hidden theme-${settings.general.theme}`;
            }, [settings]);

            useEffect(() => {
                const getTimings = async () => {
                    if (navigator.onLine) {
                        const data = await fetchPrayerTimesFromAPI(settings.location.lat, settings.location.lng, settings.offsets);
                        if (data) {
                            setTodaysTimings(data.timings);
                            return;
                        }
                    } 
                    const today = new Date();
                    const tzOffset = -today.getTimezoneOffset() / 60; 
                    const timings = PrayerCalc.getTimes(today, settings.location.lat, settings.location.lng, tzOffset, settings.offsets);
                    setTodaysTimings(timings);
                };
                getTimings();
            }, [settings.location.lat, settings.location.lng, settings.offsets]);

            useEffect(() => {
                if (!todaysTimings) return;
                const updateHijri = () => {
                    const now = new Date();
                    const [h, m] = todaysTimings.Maghrib.split(':').map(Number);
                    const maghribTime = new Date();
                    maghribTime.setHours(h, m, 0, 0);

                    const hijriBaseDate = new Date();
                    if (now >= maghribTime) {
                        hijriBaseDate.setDate(hijriBaseDate.getDate() + 1);
                    }

                    const adjustment = settings.general.hijriAdjustment || 0;
                    hijriBaseDate.setDate(hijriBaseDate.getDate() + adjustment);

                    const formatted = new Intl.DateTimeFormat('id-TN-u-ca-islamic', {
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric'
                    }).format(hijriBaseDate);
                    
                    setHijriDate(formatted);
                };

                updateHijri();
                const interval = setInterval(updateHijri, 60000);
                return () => clearInterval(interval);
            }, [todaysTimings, settings.general.hijriAdjustment]);

            const trackLocationUpdate = (newCity, lat, lng) => {
                if (firebaseAvailable && user && db) {
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('locations').add({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        uid: user.uid,
                        city: newCity,
                        lat: lat,
                        lng: lng
                    }).catch(err => console.log("Tracking location disabled offline"));
                }
            };

            const updateSettings = (section, key, value) => {
                setSettings(prev => {
                    if (section === 'root') { return { ...prev, [key]: value }; }
                    if (section === 'offsets') {
                         return { ...prev, offsets: { ...prev.offsets, [key]: value } };
                    }
                    if (section === 'financials') {
                        return { 
                            ...prev, 
                            financials: { 
                                ...prev.financials, 
                                [key]: value,
                                lastUpdated: new Date().toISOString()
                            } 
                        };
                    }
                    if (section === 'fridayInfo') {
                        return { ...prev, fridayInfo: { ...prev.fridayInfo, [key]: value } };
                    }
                    if (section === 'slides') {
                         return { ...prev, [section]: value };
                    }
                    return { ...prev, [section]: { ...prev[section], [key]: value } };
                });
            };

            const toggleMute = () => {
                updateSettings('audio', 'isMuted', !settings.audio.isMuted);
            };

            const handleImageUpload = async (file) => {
                try {
                    // Kompres gambar background (max width 1280px, quality 60%)
                    const compressedBase64 = await compressImage(file, 1280, 0.6);
                    
                    setSettings(prev => ({
                        ...prev,
                        appearance: { ...prev.appearance, bgImage: compressedBase64, customBg: compressedBase64, slideshowActive: false }
                    }));
                } catch (error) {
                    console.error("Gagal memproses gambar:", error);
                    alert("Gagal memproses gambar. Coba gunakan file lain.");
                }
            };

            return (
                <SettingsContext.Provider value={{ settings, updateSettings, toggleMute, handleImageUpload, slideshowImages, todaysTimings, hijriDate, trackLocationUpdate, user, db, appId, firebaseAvailable }}>
                    {children}
                </SettingsContext.Provider>
            );
        };

        // --- COMPONENTS ---
        const ClockDisplay = memo(({ className, size = 'normal' }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            
            const timeClass = size === 'large' ? 'text-7xl md:text-8xl' : 'text-5xl md:text-6xl';
            
            return (
                <div className={`flex flex-col text-white ${className}`}>
                    <div className="text-xs font-bold text-accent uppercase tracking-[0.2em] mb-1">Waktu Sekarang</div>
                    <h2 className={`${timeClass} font-serif font-bold text-white tabular-nums text-shadow-accent tracking-tight`}>
                        {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </h2>
                    <span className="text-lg font-light text-slate-200 tracking-widest">{time.toLocaleTimeString([], { second: '2-digit' })}</span>
                </div>
            );
        });

        const PrayerCountdown = memo(({ targetDate, nextPrayerName, status }) => {
            const [countdown, setCountdown] = useState({ h: 0, m: 0, s: 0 });
            useEffect(() => {
                if (!targetDate) return;
                const timer = setInterval(() => {
                    const now = new Date();
                    const diff = targetDate - now;
                    if (diff <= 0) {
                        setCountdown({ h: 0, m: 0, s: 0 });
                    } else {
                        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
                        const m = Math.floor((diff / (1000 * 60)) % 60);
                        const s = Math.floor((diff / 1000) % 60);
                        setCountdown({ h, m, s });
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [targetDate]);

            const fmt = (n) => String(n).padStart(2, '0');
            const isIqamah = status === 'iqamah';
            return (
                <div className="flex flex-col items-center w-full">
                    <div className={`text-sm font-bold uppercase tracking-widest mb-4 flex items-center gap-2 ${isIqamah ? 'text-red-400 animate-pulse' : 'text-accent'}`}>
                        {isIqamah && <span className="material-symbols-outlined">timer</span>}
                        Menuju {isIqamah ? `Iqomah ${nextPrayerName}` : nextPrayerName}
                    </div>
                    <div className="flex justify-center gap-4 text-center w-full">
                        <div className="flex flex-col"><span className={`text-4xl sm:text-5xl font-bold font-serif drop-shadow-md ${isIqamah ? 'text-red-400' : 'text-white'}`}>{fmt(countdown.h)}</span><span className="text-[10px] text-primary/80 uppercase tracking-widest mt-1">Jam</span></div>
                        <span className={`text-4xl sm:text-5xl font-serif animate-pulse ${isIqamah ? 'text-red-400' : 'text-accent/80'}`}>:</span>
                        <div className="flex flex-col"><span className={`text-4xl sm:text-5xl font-bold font-serif drop-shadow-md ${isIqamah ? 'text-red-400' : 'text-white'}`}>{fmt(countdown.m)}</span><span className="text-[10px] text-primary/80 uppercase tracking-widest mt-1">Menit</span></div>
                        <span className={`text-4xl sm:text-5xl font-serif animate-pulse ${isIqamah ? 'text-red-400' : 'text-accent/80'}`}>:</span>
                        <div className="flex flex-col"><span className={`text-4xl sm:text-5xl font-bold font-serif drop-shadow-md ${isIqamah ? 'text-red-400' : 'text-white'}`}>{fmt(countdown.s)}</span><span className="text-[10px] text-primary/80 uppercase tracking-widest mt-1">Detik</span></div>
                    </div>
                </div>
            );
        });

        const PrayerCard = memo(({ name, time, active, status, layout = 'classic' }) => {
            const isIqamahWaiting = active && status === 'iqamah';
            
            if (layout === 'simple') {
                return (
                    <div className={`flex items-center justify-between p-4 rounded-lg border mb-2
                        ${active 
                            ? (isIqamahWaiting ? 'bg-red-900/50 border-red-500' : 'bg-primary/20 border-primary') 
                            : 'bg-white/5 border-white/5'}`}>
                        <span className={`text-lg font-bold uppercase ${active ? 'text-white' : 'text-slate-400'}`}>{name}</span>
                        <div className="flex flex-col items-end">
                            <span className={`text-2xl font-mono font-bold ${active ? 'text-white' : 'text-slate-200'}`}>{time}</span>
                            {isIqamahWaiting && <span className="text-[10px] text-red-400 animate-pulse">IQOMAH</span>}
                        </div>
                    </div>
                );
            }

            return (
                <div className={`relative overflow-hidden rounded-xl border transition-all duration-500 group 
                    ${active 
                        ? (isIqamahWaiting 
                            ? 'border-red-500 bg-gradient-to-b from-red-900/90 to-red-950/90 shadow-[0_0_30px_rgba(239,68,68,0.3)] scale-105 z-10' 
                            : 'border-accent bg-gradient-to-b from-secondary/90 to-surface-dark/90 shadow-[0_0_30px_rgba(var(--color-accent),0.2)] scale-105 z-10') 
                        : 'border-white/10 bg-black/40 hover:bg-black/60 hover:border-white/20'}`}>
                    
                    {active && <div className={`absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent to-transparent ${isIqamahWaiting ? 'via-red-500' : 'via-accent'}`}></div>}
                    
                    <div className="p-5 flex flex-col items-center text-center relative z-10">
                        <span className={`text-sm font-bold uppercase tracking-widest mb-2 ${active ? (isIqamahWaiting ? 'text-red-300' : 'text-accent') : 'text-slate-400 group-hover:text-slate-300'}`}>{name}</span>
                        <span className={`text-2xl sm:text-3xl font-serif font-bold ${active ? 'text-white' : 'text-slate-200'}`}>{time}</span>
                        {isIqamahWaiting && <span className="text-[10px] uppercase font-bold text-red-400 mt-1 animate-pulse">Menunggu Iqomah</span>}
                    </div>
                    <div className="absolute inset-0 bg-islamic-pattern opacity-5 pointer-events-none"></div>
                </div>
            );
        });

        const HadithSection = memo(() => {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const day = Math.floor(diff / oneDay);
            const todaysHadith = HADITH_COLLECTION[day % HADITH_COLLECTION.length];

            return (
                <div className="lg:col-span-2 rounded-2xl bg-gradient-to-br from-surface-dark/95 to-background-dark/95 backdrop-blur-sm p-6 border border-white/10 flex items-center gap-6 h-full">
                    <div className="hidden sm:flex h-16 w-16 shrink-0 items-center justify-center rounded-full bg-accent/10 text-accent border border-accent/20">
                        <span className="material-symbols-outlined text-3xl">menu_book</span>
                    </div>
                    <div>
                        <h4 className="text-sm font-bold uppercase text-accent mb-2">Hadits Hari Ini</h4>
                        <p className="text-lg font-medium text-white italic leading-relaxed">"{todaysHadith.text}"</p>
                        <p className="mt-2 text-sm text-slate-400">— {todaysHadith.source}</p>
                    </div>
                </div>
            );
        });

        const InfaqWidget = memo(({ financials }) => {
            const dateStr = financials.lastUpdated ? new Date(financials.lastUpdated).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';
            return (
                <div className="rounded-2xl bg-surface-dark/95 backdrop-blur-sm p-5 border border-white/10 flex flex-col justify-between h-full">
                    <div className="flex justify-between items-center mb-3">
                        <h4 className="text-sm font-bold uppercase text-accent flex items-center gap-2">
                            <span className="material-symbols-outlined text-lg">account_balance_wallet</span>
                            Infaq & Sedekah
                        </h4>
                    </div>
                    <div className="flex flex-col gap-4">
                         <div className="bg-black/20 rounded-xl p-3 border border-white/5">
                            <p className="text-xs text-slate-400 mb-1">Total Saldo</p>
                            <p className="text-2xl font-bold text-white font-serif">{formatRupiah(financials.balance)}</p>
                         </div>
                         <div className="grid grid-cols-2 gap-3">
                            <div className="flex flex-col">
                                <div className="flex items-center gap-1 text-emerald-400 text-xs font-bold uppercase mb-1"><span className="material-symbols-outlined text-sm">arrow_upward</span> Masuk</div>
                                <span className="text-lg font-bold text-slate-200">{formatRupiah(financials.income)}</span>
                            </div>
                            <div className="flex flex-col">
                                <div className="flex items-center gap-1 text-red-400 text-xs font-bold uppercase mb-1"><span className="material-symbols-outlined text-sm">arrow_downward</span> Keluar</div>
                                <span className="text-lg font-bold text-slate-200">{formatRupiah(financials.expense)}</span>
                            </div>
                         </div>
                         <div className="text-[10px] text-slate-500 text-right mt-1 italic">Data per: {dateStr}</div>
                    </div>
                </div>
            );
        });
        
        const FinancialSlide = memo(({ financials }) => {
             const dateStr = financials.lastUpdated ? new Date(financials.lastUpdated).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';
             return (
                 <div className="relative glass-panel rounded-3xl p-10 md:p-14 flex flex-col justify-center items-center h-full w-full shadow-2xl animate-fade-in border-accent/30 bg-surface-dark/90">
                     <h2 className="text-3xl font-serif text-accent mb-8 uppercase tracking-widest border-b border-accent/20 pb-4 w-full text-center">Laporan Keuangan Masjid</h2>
                     <div className="grid grid-cols-3 gap-8 w-full max-w-4xl">
                         <div className="bg-black/30 p-6 rounded-2xl text-center border border-emerald-500/30">
                             <div className="text-emerald-400 mb-2"><span className="material-symbols-outlined text-4xl">arrow_circle_up</span></div>
                             <div className="text-slate-400 text-sm uppercase tracking-wider mb-2">Pemasukan</div>
                             <div className="text-3xl font-bold text-white">{formatRupiah(financials.income)}</div>
                         </div>
                         <div className="bg-black/30 p-6 rounded-2xl text-center border border-red-500/30">
                             <div className="text-red-400 mb-2"><span className="material-symbols-outlined text-4xl">arrow_circle_down</span></div>
                             <div className="text-slate-400 text-sm uppercase tracking-wider mb-2">Pengeluaran</div>
                             <div className="text-3xl font-bold text-white">{formatRupiah(financials.expense)}</div>
                         </div>
                         <div className="bg-accent/10 p-6 rounded-2xl text-center border border-accent/50 scale-110 shadow-lg shadow-accent/10">
                             <div className="text-accent mb-2"><span className="material-symbols-outlined text-4xl">account_balance</span></div>
                             <div className="text-accent text-sm uppercase tracking-wider mb-2 font-bold">Total Saldo</div>
                             <div className="text-4xl font-bold text-white">{formatRupiah(financials.balance)}</div>
                         </div>
                     </div>
                     <div className="mt-8 text-slate-400 italic text-sm">Data laporan keuangan per tanggal {dateStr}</div>
                 </div>
             );
        });

        const ImageSlide = memo(({ url, caption }) => {
            return (
                <div className="relative glass-panel rounded-3xl overflow-hidden h-full w-full shadow-2xl animate-fade-in group">
                    <div className="absolute inset-0 bg-cover bg-center transition-transform duration-[10000ms] ease-linear transform scale-100 group-hover:scale-110" style={{backgroundImage: `url("${url}")`}}></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/30"></div>
                    {caption && (
                        <div className="absolute bottom-0 left-0 right-0 p-8 text-center">
                            <h2 className="text-3xl md:text-4xl font-bold text-white font-serif drop-shadow-xl">{caption}</h2>
                        </div>
                    )}
                </div>
            );
        });

        const FridayWidget = memo(({ fridayInfo }) => {
            return (
                <div className="bg-surface-dark/60 border border-accent/20 px-4 py-3 rounded-xl animate-fade-in w-full">
                    <div className="flex items-center gap-2 mb-3 border-b border-white/10 pb-2">
                        <span className="material-symbols-outlined text-accent text-xl">mosque</span>
                        <span className="text-xs text-slate-300 uppercase tracking-widest font-bold">Petugas Jumat</span>
                    </div>
                    <div className="space-y-3">
                        <div className="flex items-center justify-between"><span className="text-xs text-slate-400">Khatib</span><span className="text-sm font-bold text-white text-right">{(fridayInfo && fridayInfo.khatib) || "-"}</span></div>
                        <div className="flex items-center justify-between"><span className="text-xs text-slate-400">Imam</span><span className="text-sm font-bold text-white text-right">{(fridayInfo && fridayInfo.imam) || "-"}</span></div>
                        <div className="flex items-center justify-between"><span className="text-xs text-slate-400">Muadzin</span><span className="text-sm font-bold text-white text-right">{(fridayInfo && fridayInfo.muadzin) || "-"}</span></div>
                    </div>
                </div>
            );
        });

        const NextEventWidget = memo(({ nextEvent }) => {
            if (!nextEvent) return null;
            const today = new Date();
            today.setHours(0,0,0,0);
            const eventDate = new Date(nextEvent.date);
            const diffTime = eventDate - today;
            const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return (
                 <div className="bg-surface-dark/60 border border-accent/20 px-4 py-3 rounded-xl flex items-center gap-4 animate-fade-in w-full md:w-auto">
                    <div className="bg-accent/20 p-2 rounded-lg text-accent"><span className="material-symbols-outlined text-2xl">event</span></div>
                    <div className="flex flex-col">
                        <span className="text-xs text-slate-400 uppercase tracking-widest font-bold">Agenda Berikutnya</span>
                        <div className="flex items-baseline gap-2">
                             <span className="text-lg font-bold text-white">{nextEvent.name}</span>
                             <span className="text-xs text-accent bg-accent/10 px-2 py-0.5 rounded-full font-bold">{daysLeft === 0 ? "HARI INI" : `${daysLeft} Hari Lagi`}</span>
                        </div>
                        <span className="text-xs text-slate-500 mt-0.5">{new Date(nextEvent.date).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
                    </div>
                 </div>
            );
        });

        const RunningTextBanner = memo(({ active, texts, speed, size }) => {
            if (!active || !texts || texts.length === 0) return null;
            const fontSizeClass = { small: "text-sm", medium: "text-base", large: "text-lg", xl: "text-xl" }[size] || "text-base";
            const duration = 40 - (speed * 3); 
            const displayText = texts.join(" ••• ");

            return (
                <div className="fixed bottom-0 left-0 right-0 z-50 bg-surface-dark backdrop-blur-md border-t border-white/10 h-12 flex items-center overflow-hidden shadow-2xl">
                    <div className="flex items-center justify-center bg-accent text-black font-bold px-6 h-full shrink-0 z-10 text-sm uppercase tracking-wider shadow-lg">Info Masjid</div>
                    <div className="flex-1 overflow-hidden relative h-full flex items-center">
                        <div className="whitespace-nowrap absolute flex items-center gap-8" style={{ animation: `marquee ${Math.max(5, duration)}s linear infinite` }}>
                           <span className={`${fontSizeClass} font-medium text-white tracking-wide font-arabic`}>{displayText}</span>
                           <span className={`${fontSizeClass} font-medium text-white tracking-wide font-arabic pl-24`}>{displayText}</span> 
                        </div>
                    </div>
                     <style>{`@keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }`}</style>
                </div>
            );
        });

        // --- LAYOUTS ---

        const ClassicLayout = ({ settings, hijriDate, infoWidget, renderCentralArea, displayPrayers, nextPrayer }) => (
            <div className="flex flex-col gap-12">
                <div className="flex flex-col md:flex-row justify-between items-center md:items-end gap-8 pb-8 border-b border-white/10">
                    <div className="flex flex-col gap-2 text-center md:text-left">
                        <div className="flex items-center justify-center md:justify-start gap-2 text-accent"><span className="material-symbols-outlined">calendar_month</span><span className="text-lg font-bold tracking-widest uppercase">{new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span></div>
                        <p className="text-2xl font-serif text-slate-100">{hijriDate || "Memuat Tanggal Hijriah..."}</p>
                    </div>
                    <div className="flex flex-col items-end gap-4 w-full md:w-auto"><ClockDisplay className="items-end" />{infoWidget}</div>
                </div>
                <div className="h-[400px] flex items-center justify-center">{renderCentralArea()}</div>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    {displayPrayers.map((p) => {
                        const isNext = nextPrayer && (nextPrayer.name === p.name || (nextPrayer.name === 'Fajr' && p.name === 'Subuh') || (nextPrayer.name === 'Sunrise' && p.name === 'Terbit'));
                        return <PrayerCard key={p.name} name={p.name} time={p.time} active={isNext} status={nextPrayer ? nextPrayer.status : 'adhan'} />;
                    })}
                </div>
                <section className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <HadithSection />
                    <InfaqWidget financials={settings.financials || { balance: 0, income: 0, expense: 0 }} />
                </section>
            </div>
        );

        const ModernLayout = ({ settings, hijriDate, infoWidget, renderCentralArea, displayPrayers, nextPrayer }) => (
            <div className="grid grid-cols-12 gap-6 h-full">
                {/* Left Sidebar (Info & Times) */}
                <div className="col-span-12 lg:col-span-3 flex flex-col gap-4">
                    <div className="bg-surface-dark/90 backdrop-blur-md p-6 rounded-2xl border border-white/10 flex flex-col items-center text-center">
                        <ClockDisplay className="items-center mb-4" />
                        <div className="w-full h-px bg-white/10 my-4"></div>
                        <p className="text-lg font-serif text-slate-200">{hijriDate}</p>
                        <p className="text-sm text-slate-400 mt-1">{new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                    </div>
                    
                    <div className="bg-surface-dark/80 backdrop-blur-md p-4 rounded-2xl border border-white/10 flex-1 flex flex-col gap-2 overflow-y-auto">
                        <h4 className="text-xs font-bold text-accent uppercase tracking-widest mb-2 text-center">Jadwal Sholat</h4>
                        {displayPrayers.map((p) => {
                            const isNext = nextPrayer && (nextPrayer.name === p.name || (nextPrayer.name === 'Fajr' && p.name === 'Subuh') || (nextPrayer.name === 'Sunrise' && p.name === 'Terbit'));
                            return <PrayerCard key={p.name} name={p.name} time={p.time} active={isNext} status={nextPrayer ? nextPrayer.status : 'adhan'} layout="simple" />;
                        })}
                    </div>
                </div>

                {/* Right Content */}
                <div className="col-span-12 lg:col-span-9 flex flex-col gap-6">
                    {/* Main Slide Area */}
                    <div className="flex-1 min-h-[400px] rounded-3xl overflow-hidden relative">
                         {renderCentralArea()}
                    </div>
                    
                    {/* Bottom Widgets */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 h-48">
                        <HadithSection />
                        <div className="flex flex-col gap-4">
                            {infoWidget}
                            <div className="flex-1 bg-surface-dark/80 rounded-xl border border-white/10 p-4 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="bg-emerald-500/20 p-2 rounded-lg text-emerald-400"><span className="material-symbols-outlined">account_balance_wallet</span></div>
                                    <div>
                                        <p className="text-xs text-slate-400 uppercase">Saldo Infaq</p>
                                        <p className="text-xl font-bold font-mono text-white">{formatRupiah((settings.financials && settings.financials.balance) || 0)}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const SimpleLayout = ({ settings, hijriDate, infoWidget, renderCentralArea, displayPrayers, nextPrayer }) => (
            <div className="flex flex-col h-full justify-between gap-8 py-10">
                <div className="text-center">
                    <h1 className="text-4xl font-bold font-serif text-white mb-2">{settings.general.mosqueName}</h1>
                    <p className="text-xl text-slate-400">{settings.location.city} | {hijriDate}</p>
                </div>

                <div className="flex-1 flex items-center justify-center w-full max-w-5xl mx-auto gap-12">
                    <div className="flex-1 flex justify-center">
                        <ClockDisplay className="items-center" size="large" />
                    </div>
                    <div className="w-px h-64 bg-white/10 hidden md:block"></div>
                    <div className="flex-1 flex flex-col gap-4 w-full">
                         {displayPrayers.map((p) => {
                            const isNext = nextPrayer && (nextPrayer.name === p.name || (nextPrayer.name === 'Fajr' && p.name === 'Subuh') || (nextPrayer.name === 'Sunrise' && p.name === 'Terbit'));
                            return (
                                <div key={p.name} className={`flex justify-between items-center px-6 py-3 rounded-lg border-b border-white/5 ${isNext ? 'bg-accent text-black scale-105 shadow-lg' : 'text-slate-300'}`}>
                                    <span className="text-xl font-bold uppercase">{p.name}</span>
                                    <span className="text-2xl font-mono font-bold">{p.time}</span>
                                </div>
                            );
                        })}
                    </div>
                </div>

                <div className="grid grid-cols-3 gap-6 max-w-6xl mx-auto w-full text-center">
                    <div className="bg-white/5 p-4 rounded-xl border border-white/10">
                        <p className="text-xs text-slate-400 uppercase mb-1">Saldo Kas</p>
                        <p className="text-xl font-bold">{formatRupiah((settings.financials && settings.financials.balance) || 0)}</p>
                    </div>
                    <div className="bg-white/5 p-4 rounded-xl border border-white/10">
                        <p className="text-xs text-slate-400 uppercase mb-1">Imam Jumat</p>
                        <p className="text-xl font-bold">{(settings.fridayInfo && settings.fridayInfo.imam) || "-"}</p>
                    </div>
                    <div className="bg-white/5 p-4 rounded-xl border border-white/10">
                        <p className="text-xs text-slate-400 uppercase mb-1">Khatib Jumat</p>
                        <p className="text-xl font-bold">{(settings.fridayInfo && settings.fridayInfo.khatib) || "-"}</p>
                    </div>
                </div>
            </div>
        );

        // --- PAGES ---

        const DashboardPage = () => {
            const { settings, slideshowImages, todaysTimings, hijriDate, toggleMute } = useContext(SettingsContext);
            const [bgImage, setBgImage] = useState(settings.appearance.bgImage);
            const [currentSlideIndex, setCurrentSlideIndex] = useState(0);
            const [nextPrayer, setNextPrayer] = useState(null);
            
            const template = settings.general.template || 'classic'; 
            const isFriday = new Date().getDay() === 5;
            const today = new Date();
            today.setHours(0,0,0,0);
            const nextEvent = ISLAMIC_EVENTS_2025.filter(ev => new Date(ev.date) >= today).sort((a, b) => new Date(a.date) - new Date(b.date))[0];
            const adhanAudioRef = useRef(new Audio("https://www.islamcan.com/audio/adhan/azan1.mp3"));
            const iqamahAudioRef = useRef(new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"));

            useEffect(() => {
                if (!todaysTimings) return;
                const calculateNextPrayer = () => {
                    const now = new Date();
                    const prayerOrder = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                    let found = null;
                    let target = new Date();
                    let status = 'adhan'; 
                    const iqamahDelay = settings.general.iqamahDelay || 10;
                    let prayerDuration = settings.general.prayerDuration || 10;
                    
                    for (let name of prayerOrder) {
                        const timeStr = todaysTimings[name];
                        if (!timeStr) continue;
                        const [h, m] = timeStr.split(':').map(Number);
                        const prayerTime = new Date();
                        prayerTime.setHours(h, m, 0, 0);
                        if (isFriday && name === 'Dhuhr') { prayerDuration = settings.general.fridayPrayerDuration || 30; } else { prayerDuration = settings.general.prayerDuration || 10; }
                        const iqamahTime = new Date(prayerTime.getTime() + iqamahDelay * 60000);
                        const prayerEndTime = new Date(iqamahTime.getTime() + prayerDuration * 60000);
                        const nowTs = now.getTime();
                        if (!settings.audio.isMuted && name !== 'Sunrise') {
                             if (Math.abs(nowTs - prayerTime.getTime()) < 1500) { adhanAudioRef.current.play().catch(e => console.log("Audio fail:", e)); }
                        }
                        if (!settings.audio.isMuted && name !== 'Sunrise') {
                             if (Math.abs(nowTs - iqamahTime.getTime()) < 1500) { iqamahAudioRef.current.play().catch(e => console.log("Audio fail:", e)); }
                        }
                        if (now < prayerTime) { found = { name, time: timeStr }; target = prayerTime; status = 'adhan'; break; } 
                        else if (now < iqamahTime && name !== 'Sunrise') { found = { name, time: timeStr }; target = iqamahTime; status = 'iqamah'; break; } 
                        else if (now < prayerEndTime && name !== 'Sunrise') { found = { name, time: timeStr }; target = prayerEndTime; status = 'prayer'; break; }
                    }
                    if (!found) {
                        found = { name: 'Fajr', time: todaysTimings['Fajr'] };
                        const [h, m] = found.time.split(':').map(Number);
                        target = new Date();
                        target.setDate(target.getDate() + 1);
                        target.setHours(h, m, 0, 0);
                        status = 'adhan';
                    }
                    setNextPrayer({ ...found, targetDate: target, status });
                };
                calculateNextPrayer();
                const interval = setInterval(calculateNextPrayer, 1000); 
                return () => clearInterval(interval);
            }, [todaysTimings, settings.general.iqamahDelay, settings.audio.isMuted, settings.general.prayerDuration, settings.general.fridayPrayerDuration, isFriday]);

            useEffect(() => {
                let isCritical = false;
                if (nextPrayer) {
                    const now = new Date();
                    const diffMins = (nextPrayer.targetDate - now) / 60000;
                    if (nextPrayer.status === 'iqamah' || nextPrayer.status === 'prayer' || (nextPrayer.status === 'adhan' && diffMins <= 10)) {
                        isCritical = true;
                    }
                }
                if (isCritical) {
                    setCurrentSlideIndex(0);
                    return;
                }
                const slides = settings.slides || [{ type: 'clock', duration: 15 }];
                const currentSlide = slides[currentSlideIndex % slides.length];
                const duration = (currentSlide.duration || 10) * 1000;
                const timer = setTimeout(() => {
                    setCurrentSlideIndex(prev => (prev + 1) % slides.length);
                }, duration);
                return () => clearTimeout(timer);
            }, [currentSlideIndex, nextPrayer, settings.slides]);

            const renderCentralArea = () => {
                const slides = settings.slides || [{ type: 'clock' }];
                const currentSlide = slides[currentSlideIndex % slides.length];
                
                // For modern layout, we might want to skip the 'clock' slide if it's redundant, 
                // but for simplicity, let's keep logic generic or adjust per layout if needed.
                // In Modern layout, clock is on sidebar, so 'clock' slide might be redundant there.
                
                if (currentSlide.type === 'clock') {
                    return (
                         <div className={`relative glass-panel rounded-3xl p-10 md:p-14 text-center shadow-2xl overflow-hidden group transition-colors duration-500 animate-fade-in h-full flex flex-col justify-center ${(nextPrayer && nextPrayer.status === 'iqamah') ? 'border-red-500/50 bg-red-900/20' : ''}`}>
                            <div className="absolute top-0 left-1/2 -translate-x-1/2 w-3/4 h-24 bg-gradient-to-b from-white/5 to-transparent rounded-b-full blur-xl pointer-events-none"></div>
                            <div className="relative z-10 flex flex-col items-center gap-8">
                                {nextPrayer ? (
                                    <React.Fragment>
                                        <PrayerCountdown targetDate={nextPrayer.targetDate} nextPrayerName={nextPrayer.name === 'Sunrise' ? 'Terbit' : nextPrayer.name} status={nextPrayer.status} />
                                        {nextPrayer.status === 'adhan' && <div className="flex items-center gap-3 px-6 py-2 rounded-full bg-black/30 border border-white/10 backdrop-blur-md"><span className="text-slate-300 text-sm">Waktu Adzan:</span><span className="text-xl font-bold text-white font-serif">{nextPrayer.time}</span></div>}
                                    </React.Fragment>
                                ) : <div className="animate-pulse text-primary/80">Menghitung waktu sholat...</div>}
                            </div>
                        </div>
                    );
                } else if (currentSlide.type === 'financial') {
                    return <FinancialSlide financials={settings.financials || {}} />;
                } else if (currentSlide.type === 'image') {
                    return <ImageSlide url={currentSlide.url} caption={currentSlide.caption} />;
                }
                return null;
            };

            if (nextPrayer && nextPrayer.status === 'prayer') {
                return (
                    <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center text-center p-8 cursor-none">
                         <div className="text-gray-500 text-sm uppercase tracking-[0.5em] mb-4 animate-pulse">Sedang Berlangsung</div>
                         <h1 className="text-4xl md:text-6xl font-serif text-white/90 font-bold mb-6">SHOLAT {nextPrayer.name.toUpperCase()}</h1>
                         <div className="text-accent/80 text-xl md:text-2xl font-medium tracking-wide animate-pulse">Luruskan dan Rapatkan Shaf</div>
                    </div>
                );
            }

            const displayPrayers = todaysTimings ? [
                { name: "Subuh", time: todaysTimings.Fajr }, { name: "Terbit", time: todaysTimings.Sunrise }, { name: "Dzuhur", time: todaysTimings.Dhuhr },
                { name: "Ashar", time: todaysTimings.Asr }, { name: "Maghrib", time: todaysTimings.Maghrib }, { name: "Isya", time: todaysTimings.Isha },
            ] : [];

            const infoWidget = isFriday ? <FridayWidget fridayInfo={settings.fridayInfo || {}} /> : <NextEventWidget nextEvent={nextEvent} />;

            return (
                <div className="relative z-10 flex min-h-screen w-full flex-col overflow-x-hidden font-display pb-16 text-white">
                    <div className="fixed inset-0 z-0 bg-black">
                        <div className="absolute inset-0 bg-cover bg-center transition-all duration-[2000ms]" style={{ backgroundImage: `url("${settings.appearance.bgImage}")`, filter: `blur(${settings.appearance.blur}px)` }}></div>
                        <div className="absolute inset-0 bg-gradient-to-b from-surface-dark/80 via-background-dark/60 to-surface-dark/90" style={{ opacity: settings.appearance.opacity / 100 }}></div>
                        <div className="absolute inset-0 bg-islamic-pattern opacity-10"></div>
                    </div>
                    <div className="relative z-10 flex flex-col min-h-screen">
                        {/* Only show header in Classic and Modern modes, Simple hides it to focus on content */}
                        {template !== 'simple' && (
                            <header className="w-full border-b border-white/10 bg-gradient-to-b from-surface-dark/90 to-transparent backdrop-blur-sm">
                                <div className="px-6 lg:px-12 py-5 flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <div className="flex items-center justify-center size-12 rounded-xl bg-accent/10 text-accent border border-accent/30 shadow-[0_0_15px_rgba(var(--color-accent),0.3)]"><span className="material-symbols-outlined text-3xl">mosque</span></div>
                                        <div className="flex flex-col"><h2 className="text-xl font-bold tracking-tight text-white font-serif">{settings.general.mosqueName}</h2><p className="text-xs text-primary/80 tracking-wider uppercase">Prayer Dashboard</p></div>
                                    </div>
                                    <div className="hidden md:flex items-center gap-6">
                                         <button onClick={toggleMute} className={`flex items-center justify-center size-10 rounded-full border border-white/10 transition-colors ${settings.audio.isMuted ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30' : 'bg-primary/20 text-primary hover:bg-primary/30'}`} title={settings.audio.isMuted ? "Unmute Sound" : "Mute Sound"}><span className="material-symbols-outlined">{settings.audio.isMuted ? 'volume_off' : 'volume_up'}</span></button>
                                        <Link to="/settings" className="flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 hover:border-accent/50 transition-all group"><span className="material-symbols-outlined text-accent group-hover:animate-spin">settings</span><span className="text-sm font-medium">{settings.location.city}</span></Link>
                                    </div>
                                </div>
                            </header>
                        )}
                        
                        {/* Simple mode setting button (floating) since header is hidden */}
                        {template === 'simple' && (
                             <Link to="/settings" className="fixed top-4 right-4 z-50 p-2 rounded-full bg-white/10 hover:bg-white/20 text-slate-400 hover:text-white transition-all"><span className="material-symbols-outlined">settings</span></Link>
                        )}

                        <main className="flex-1 px-4 sm:px-8 lg:px-12 py-8 flex flex-col justify-center">
                            <div className="mx-auto max-w-7xl w-full h-full">
                                {template === 'modern' ? (
                                    <ModernLayout 
                                        settings={settings} 
                                        hijriDate={hijriDate} 
                                        infoWidget={infoWidget} 
                                        renderCentralArea={renderCentralArea} 
                                        displayPrayers={displayPrayers} 
                                        nextPrayer={nextPrayer} 
                                    />
                                ) : template === 'simple' ? (
                                    <SimpleLayout 
                                        settings={settings} 
                                        hijriDate={hijriDate} 
                                        infoWidget={infoWidget} 
                                        renderCentralArea={renderCentralArea} 
                                        displayPrayers={displayPrayers} 
                                        nextPrayer={nextPrayer} 
                                    />
                                ) : (
                                    <ClassicLayout 
                                        settings={settings} 
                                        hijriDate={hijriDate} 
                                        infoWidget={infoWidget} 
                                        renderCentralArea={renderCentralArea} 
                                        displayPrayers={displayPrayers} 
                                        nextPrayer={nextPrayer} 
                                    />
                                )}
                            </div>
                        </main>
                    </div>
                    <RunningTextBanner active={settings.runningText.active} texts={settings.runningText.texts} speed={settings.runningText.speed} size={settings.runningText.size} />
                </div>
            );
        };

        const SettingsPage = () => {
            const navigate = useNavigate();
            const { settings, updateSettings, handleImageUpload, trackLocationUpdate, user, db, appId, firebaseAvailable } = useContext(SettingsContext);
            const fileInputRef = useRef(null);
            const slideFileInputRef = useRef(null);
            const [newRunningText, setNewRunningText] = useState("");
            const [isLoadingLocation, setIsLoadingLocation] = useState(false);
            const [visitStats, setVisitStats] = useState({ count: 0, locations: [] });

            useEffect(() => {
                if (firebaseAvailable && user && db) {
                    const fetchStats = async () => {
                        try {
                            const visitsSnapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('visits').get();
                            const locationsSnapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('locations').orderBy('timestamp', 'desc').limit(5).get();
                            const locs = [];
                            locationsSnapshot.forEach(doc => locs.push(doc.data()));
                            setVisitStats({ count: visitsSnapshot.size, locations: locs });
                        } catch (e) { console.log("Error fetching stats", e); }
                    };
                    fetchStats();
                }
            }, [user, firebaseAvailable]);

            const themes = [
                { id: 'emerald', name: 'Emerald', color: '#10b981' },
                { id: 'ocean', name: 'Ocean', color: '#0ea5e9' },
                { id: 'sunset', name: 'Sunset', color: '#f97316' },
                { id: 'amethyst', name: 'Amethyst', color: '#a855f7' },
                { id: 'midnight', name: 'Midnight', color: '#6366f1' },
                { id: 'earth', name: 'Earth', color: '#84cc16' }
            ];

            const templates = [
                { id: 'classic', name: 'Classic (Kubah)', icon: 'church' },
                { id: 'modern', name: 'Modern (Split)', icon: 'grid_view' },
                { id: 'simple', name: 'Simple (Minimal)', icon: 'crop_square' }
            ];

            const onFileChange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await handleImageUpload(file);
                    e.target.value = ""; // Reset input agar bisa upload file yang sama jika gagal
                }
            };

            const addRunningText = () => {
                if (newRunningText.trim()) {
                    const updatedTexts = [...(settings.runningText.texts || []), newRunningText];
                    updateSettings('runningText', 'texts', updatedTexts);
                    setNewRunningText("");
                }
            };
            const removeRunningText = (index) => {
                const updatedTexts = settings.runningText.texts.filter((_, i) => i !== index);
                updateSettings('runningText', 'texts', updatedTexts);
            };

            const handleAutoLocation = () => {
                setIsLoadingLocation(true);
                const useMockLocation = (reason) => {
                    setTimeout(() => {
                        const mockLat = -6.1754; const mockLng = 106.8272;
                        updateSettings('location', 'lat', mockLat);
                        updateSettings('location', 'lng', mockLng);
                        updateSettings('location', 'city', "Jakarta Pusat, DKI Jakarta (Demo)");
                        setIsLoadingLocation(false);
                        alert(`Lokasi diatur ke Jakarta Pusat (Mode Demo). ${reason}`);
                    }, 1000);
                };
                if (!navigator.geolocation) { useMockLocation("Geolocation tidak didukung."); return; }
                try {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        updateSettings('location', 'lat', latitude);
                        updateSettings('location', 'lng', longitude);
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10&addressdetails=1`);
                            if (!response.ok) throw new Error("Network error");
                            const data = await response.json();
                            const city = data.address.city || data.address.town || "Lokasi Terdeteksi";
                            updateSettings('location', 'city', city);
                        } catch (error) {
                            updateSettings('location', 'city', `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                        } finally { setIsLoadingLocation(false); }
                    }, (error) => { useMockLocation("Izin ditolak atau error."); }, { enableHighAccuracy: false, timeout: 5000 });
                } catch (e) { useMockLocation("Error sistem."); }
            };

            // Slide Management
            const handleAddSlideImage = async (e) => {
                const file = e.target.files[0];
                if (file) {
                   try {
                       // Kompres gambar slide (max width 800px, quality 60%) agar hemat memori
                       const compressedBase64 = await compressImage(file, 800, 0.6);
                       
                       const newSlides = [...settings.slides, { type: 'image', url: compressedBase64, duration: 10 }];
                       updateSettings('slides', newSlides);
                   } catch (error) {
                       console.error("Gagal upload slide:", error);
                       alert("Gagal menambahkan slide. Pastikan format gambar benar.");
                   }
                   e.target.value = ""; // Reset input
                }
            };
            const removeSlide = (idx) => {
                const newSlides = settings.slides.filter((_, i) => i !== idx);
                updateSettings('slides', newSlides);
            };

            const updateSlideDuration = (idx, newDuration) => {
                const newSlides = [...settings.slides];
                newSlides[idx].duration = newDuration || 10; // Fallback ke 10 detik jika kosong
                updateSettings('slides', newSlides);
            };

            return (
                <div className="bg-background-dark font-display min-h-screen flex flex-col text-white">
                    <header className="border-b border-white/10 px-6 py-4 bg-surface-dark flex items-center justify-between sticky top-0 z-50">
                        <h2 className="text-xl font-bold font-serif text-accent">Pengaturan</h2>
                        <button onClick={() => navigate('/')} className="text-sm font-bold bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg">Simpan & Kembali</button>
                    </header>
                    <main className="flex-1 p-6 md:p-10 max-w-4xl mx-auto w-full flex flex-col gap-8">
                        <section className="bg-surface-dark border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-primary mb-4 flex items-center gap-2"><span className="material-symbols-outlined">settings</span>Umum</h3>
                            <div className="flex flex-col gap-4">
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Nama Masjid</span><input className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.general.mosqueName} onChange={(e) => updateSettings('general', 'mosqueName', e.target.value)} placeholder="Contoh: Masjid Al-Ikhlas"/></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Jeda Iqomah (Menit)</span><input type="number" min="1" max="60" className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.general.iqamahDelay} onChange={(e) => updateSettings('general', 'iqamahDelay', parseInt(e.target.value) || 10)} /></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Durasi Mode Sholat Jumat (Menit)</span><input type="number" min="1" max="120" className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.general.fridayPrayerDuration || 30} onChange={(e) => updateSettings('general', 'fridayPrayerDuration', parseInt(e.target.value) || 30)} /></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Durasi Mode Sholat (Menit)</span><input type="number" min="1" max="60" className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.general.prayerDuration || 10} onChange={(e) => updateSettings('general', 'prayerDuration', parseInt(e.target.value) || 10)} /></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Koreksi Tanggal Hijriah (Hari)</span><input type="number" min="-2" max="2" className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.general.hijriAdjustment || 0} onChange={(e) => updateSettings('general', 'hijriAdjustment', parseInt(e.target.value) || 0)} /></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Tema Warna</span><div className="flex gap-4 flex-wrap">{themes.map(theme => (<button key={theme.id} onClick={() => updateSettings('general', 'theme', theme.id)} className={`flex items-center gap-2 px-4 py-2 rounded-full border ${settings.general.theme === theme.id ? 'border-accent bg-white/10' : 'border-white/10 bg-transparent'} transition-all`}><div className="w-4 h-4 rounded-full" style={{backgroundColor: theme.color}}></div><span className="text-sm">{theme.name}</span></button>))}</div></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Template Tampilan</span><div className="flex gap-4 flex-wrap">{templates.map(tmpl => (<button key={tmpl.id} onClick={() => updateSettings('general', 'template', tmpl.id)} className={`flex items-center gap-2 px-4 py-2 rounded-lg border ${settings.general.template === tmpl.id ? 'border-accent bg-white/10 text-accent' : 'border-white/10 bg-transparent text-slate-400'} transition-all`}><span className="material-symbols-outlined">{tmpl.icon}</span><span className="text-sm">{tmpl.name}</span></button>))}</div></label>
                            </div>
                        </section>

                        {/* FRIDAY INFO SETTINGS SECTION */}
                        <section className="bg-surface-dark border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-accent mb-4 flex items-center gap-2"><span className="material-symbols-outlined">mosque</span>Petugas Jumat</h3>
                            <div className="flex flex-col gap-4">
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Khatib</span><input className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.fridayInfo && settings.fridayInfo.khatib || ""} onChange={(e) => updateSettings('fridayInfo', 'khatib', e.target.value)} placeholder="Nama Khatib"/></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Imam</span><input className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.fridayInfo && settings.fridayInfo.imam || ""} onChange={(e) => updateSettings('fridayInfo', 'imam', e.target.value)} placeholder="Nama Imam"/></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Muadzin</span><input className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.fridayInfo && settings.fridayInfo.muadzin || ""} onChange={(e) => updateSettings('fridayInfo', 'muadzin', e.target.value)} placeholder="Nama Muadzin"/></label>
                            </div>
                        </section>
                        
                        <section className="bg-surface-dark border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-accent mb-4 flex items-center gap-2"><span className="material-symbols-outlined">account_balance_wallet</span>Data Keuangan (Infaq)</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Saldo Saat Ini</span><input type="number" className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={(settings.financials && settings.financials.balance) || 0} onChange={(e) => updateSettings('financials', 'balance', parseInt(e.target.value) || 0)} /></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Pemasukan (Minggu Ini)</span><input type="number" className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={(settings.financials && settings.financials.income) || 0} onChange={(e) => updateSettings('financials', 'income', parseInt(e.target.value) || 0)} /></label>
                                <label className="flex flex-col gap-2"><span className="text-sm font-medium text-slate-300">Pengeluaran (Minggu Ini)</span><input type="number" className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={(settings.financials && settings.financials.expense) || 0} onChange={(e) => updateSettings('financials', 'expense', parseInt(e.target.value) || 0)} /></label>
                            </div>
                        </section>

                        <section className="bg-surface-dark border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-primary mb-4 flex items-center gap-2"><span className="material-symbols-outlined">location_on</span>Lokasi</h3>
                            <div className="flex flex-col gap-4">
                                <label className="flex items-center gap-2 mb-2 cursor-pointer"><input type="checkbox" checked={settings.location.manual} onChange={(e) => updateSettings('location', 'manual', e.target.checked)} className="accent-accent w-4 h-4"/><span className="text-sm text-slate-300">Input Manual (Latitude/Longitude)</span></label>
                                {settings.location.manual ? (<div className="grid grid-cols-2 gap-4"><input className="bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.location.lat} onChange={(e) => updateSettings('location', 'lat', parseFloat(e.target.value))} placeholder="Latitude"/><input className="bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.location.lng} onChange={(e) => updateSettings('location', 'lng', parseFloat(e.target.value))} placeholder="Longitude"/></div>) : (<div className="flex flex-col gap-4"><input className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-accent outline-none transition-colors" value={settings.location.city} readOnly placeholder="Nama Kota"/><button onClick={handleAutoLocation} disabled={isLoadingLocation} className="flex items-center justify-center gap-2 bg-primary hover:bg-secondary py-3 rounded-lg font-bold transition-all disabled:opacity-50 text-white">{isLoadingLocation ? <span className="animate-spin material-symbols-outlined">progress_activity</span> : <span className="material-symbols-outlined">my_location</span>}{isLoadingLocation ? 'Mendeteksi...' : 'Deteksi Otomatis'}</button></div>)}
                            </div>
                        </section>
                         <section className="bg-surface-dark border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-primary mb-4 flex items-center gap-2"><span className="material-symbols-outlined">subtitles</span>Running Text</h3>
                            <div className="flex flex-col gap-4 mb-4">{settings.runningText.texts && settings.runningText.texts.map((txt, idx) => (<div key={idx} className="flex gap-2 items-center bg-black/20 p-2 rounded-lg"><div className="flex-1 text-sm text-slate-300">{txt}</div><button onClick={() => removeRunningText(idx)} className="text-red-400 hover:text-red-300"><span className="material-symbols-outlined text-lg">delete</span></button></div>))}</div>
                            <div className="flex gap-2 mb-4"><input className="flex-1 bg-black/40 border border-white/10 rounded-lg px-4 py-2 focus:border-accent outline-none transition-colors text-sm" value={newRunningText} onChange={(e) => setNewRunningText(e.target.value)} placeholder="Tambah teks baru..." onKeyPress={(e) => e.key === 'Enter' && addRunningText()}/><button onClick={addRunningText} className="bg-primary hover:bg-secondary px-4 py-2 rounded-lg text-white"><span className="material-symbols-outlined">add</span></button></div>
                            <div className="flex items-center justify-between"><span className="text-sm text-slate-400">Aktifkan</span><input type="checkbox" checked={settings.runningText.active} onChange={(e) => updateSettings('runningText', 'active', e.target.checked)} className="accent-accent w-5 h-5"/></div>
                        </section>
                        
                        {/* SLIDESHOW MANAGER */}
                        <section className="bg-surface-dark border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-accent mb-4 flex items-center gap-2"><span className="material-symbols-outlined">collections</span>Mading Digital (Slideshow)</h3>
                            <p className="text-xs text-slate-400 mb-4">Konten ini akan muncul bergantian di area tengah dashboard. Batas aman: 5-10 gambar.</p>
                            <div className="flex flex-col gap-4">
                                {settings.slides.map((slide, idx) => (
                                    <div key={idx} className="flex flex-col sm:flex-row sm:items-center justify-between bg-black/20 p-3 rounded-lg border border-white/5 gap-4">
                                        <div className="flex items-center gap-3 flex-1">
                                            <span className="text-xs font-bold text-slate-500">#{idx + 1}</span>
                                            {slide.type === 'clock' && <div className="flex items-center gap-2"><span className="material-symbols-outlined text-primary">schedule</span><span className="text-sm font-bold text-primary">Jam Utama</span></div>}
                                            {slide.type === 'financial' && <div className="flex items-center gap-2"><span className="material-symbols-outlined text-accent">account_balance</span><span className="text-sm font-bold text-accent">Laporan Keuangan</span></div>}
                                            {slide.type === 'image' && <div className="flex items-center gap-2"><img src={slide.url} className="w-10 h-10 object-cover rounded border border-white/10" alt="Slide" /><span className="text-sm text-slate-300">Poster Gambar</span></div>}
                                        </div>
                                        
                                        <div className="flex items-center gap-4 justify-end">
                                            <div className="flex flex-col items-end">
                                                <label className="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Durasi (Detik)</label>
                                                <input 
                                                    type="number" 
                                                    min="5" 
                                                    max="300"
                                                    className="w-20 bg-black/40 border border-white/10 rounded px-2 py-1 text-right text-sm text-white focus:border-accent outline-none"
                                                    value={slide.duration || 10} 
                                                    onChange={(e) => updateSlideDuration(idx, parseInt(e.target.value))}
                                                />
                                            </div>
                                            {slide.type !== 'clock' && (
                                                <button onClick={() => removeSlide(idx)} className="bg-red-500/10 hover:bg-red-500/20 text-red-400 p-2 rounded-lg transition-colors" title="Hapus Slide">
                                                    <span className="material-symbols-outlined text-lg">delete</span>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                <div className="flex gap-2 mt-4 pt-4 border-t border-white/5">
                                    <button onClick={() => fileInputRef.current.click()} className="flex-1 bg-accent/10 hover:bg-accent/20 border border-dashed border-accent/30 text-accent py-3 rounded-lg text-sm flex items-center justify-center gap-2 font-bold transition-all">
                                        <span className="material-symbols-outlined">add_photo_alternate</span> Tambah Poster Baru
                                    </button>
                                    <input type="file" ref={fileInputRef} onChange={handleAddSlideImage} accept="image/*" className="hidden"/>
                                </div>
                            </div>
                        </section>

                         <section className="bg-surface-dark border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-primary mb-4 flex items-center gap-2"><span className="material-symbols-outlined">palette</span>Background</h3>
                            <div onClick={() => fileInputRef.current.click()} className="cursor-pointer rounded-lg border-2 border-dashed border-white/20 hover:border-accent flex flex-col items-center justify-center aspect-video gap-2 transition-colors bg-black/20"><span className="material-symbols-outlined text-2xl text-accent">upload</span><span className="text-xs">Upload Gambar Sendiri</span><input type="file" ref={fileInputRef} onChange={onFileChange} accept="image/*" className="hidden"/></div>
                        </section>
                        <section className="bg-surface-dark border border-white/5 rounded-2xl p-6 opacity-75 hover:opacity-100 transition-opacity">
                             <h3 className="text-lg font-bold text-accent mb-4 flex items-center gap-2"><span className="material-symbols-outlined">analytics</span>Statistik Pengguna</h3>
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-black/20 p-4 rounded-xl flex flex-col items-center justify-center text-center"><span className="text-4xl font-bold text-white mb-2">{visitStats.count}</span><span className="text-sm text-slate-400">Total Kunjungan Aplikasi</span></div>
                                <div className="bg-black/20 p-4 rounded-xl"><h4 className="text-sm font-bold text-slate-300 mb-3 border-b border-white/10 pb-2">Lokasi Terakhir Terdeteksi</h4><div className="flex flex-col gap-2">{visitStats.locations.length > 0 ? visitStats.locations.map((loc, idx) => (<div key={idx} className="flex justify-between items-center text-xs"><span className="text-primary truncate max-w-[70%]">{loc.city}</span><span className="text-slate-500">Baru saja</span></div>)) : <span className="text-xs text-slate-500 italic">Belum ada data lokasi GPS</span>}</div></div>
                             </div>
                             <p className="text-10px text-slate-500 mt-4 text-center">* Data ini anonim dan hanya mencatat jika pengguna mengaktifkan fitur lokasi otomatis.</p>
                        </section>
                    </main>
                </div>
            );
        };

        const App = () => {
            return (
                <SettingsProvider>
                    <HashRouter>
                        <Routes>
                            <Route path="/" element={<DashboardPage />} />
                            <Route path="/settings" element={<SettingsPage />} />
                        </Routes>
                    </HashRouter>
                </SettingsProvider>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
