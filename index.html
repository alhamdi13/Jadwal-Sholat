<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>MuslimPro & Prayer Dashboard</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet"/>
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#10b981", // Emerald 500
                        "primary-dark": "#047857", // Emerald 700
                        "gold": "#fbbf24", // Amber 400
                        "gold-dark": "#d97706", // Amber 600
                        "background-light": "#f0fdf4",
                        "background-dark": "#022c22", // Very dark emerald
                        "surface-dark": "#064e3b",
                        "surface-light": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"],
                        "arabic": ["Amiri", "serif"],
                        "serif": ["Cinzel", "serif"],
                    },
                    backgroundImage: {
                        'islamic-pattern': "url('https://www.transparenttextures.com/patterns/arabesque.png')",
                    },
                    animation: {
                        'marquee': 'marquee 25s linear infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        marquee: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(-100%)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #047857; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #10b981; 
        }
        .compass-dial {
            transition: transform 0.5s cubic-bezier(0.4, 2, 0.55, 0.44);
        }
        .glass-panel {
            background: rgba(6, 78, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        .text-shadow-gold {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3), 0 0 2px rgba(251, 191, 36, 0.5);
        }
        .arch-shape {
            mask-image: radial-gradient(circle at 50% 120%, transparent 40%, black 41%);
            -webkit-mask-image: radial-gradient(circle at 50% 120%, transparent 40%, black 41%);
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white transition-colors duration-500 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, memo, useMemo, createContext, useContext, useRef } = React;
        const { createRoot } = ReactDOM;
        const { MemoryRouter, Routes, Route, Link, useNavigate } = ReactRouterDOM;

        // --- API & UTILS ---
        const apiKey = ""; 

        const callGeminiAPI = async (prompt, systemInstruction = "") => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            arabic: { type: "STRING" },
                            latin: { type: "STRING" },
                            translation: { type: "STRING" },
                            advice: { type: "STRING" }
                        }
                    }
                }
            };

            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    let text = null;
                    if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
                        text = data.candidates[0].content.parts[0].text;
                    }
                    return JSON.parse(text);
                } catch (error) {
                    if (i === 4) throw error;
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        };

        const fetchPrayerTimesFromAPI = async (lat, lng, month, year) => {
            try {
                // Fetch daily timings
                const response = await fetch(`https://api.aladhan.com/v1/timings/${Math.floor(Date.now() / 1000)}?latitude=${lat}&longitude=${lng}&method=20`); // Method 20 is Kemenag Indonesia usually, or 2 for ISNA
                if (!response.ok) throw new Error("Failed to fetch prayer times");
                const data = await response.json();
                return data.data; // Contains timings, date, meta
            } catch (error) {
                console.error("API Error:", error);
                return null;
            }
        };

        const fetchMonthlyPrayerTimesFromAPI = async (lat, lng, month, year) => {
            try {
                const response = await fetch(`https://api.aladhan.com/v1/calendar?latitude=${lat}&longitude=${lng}&method=20&month=${month}&year=${year}`);
                if (!response.ok) throw new Error("Failed to fetch monthly times");
                const data = await response.json();
                return data.data; 
            } catch (error) {
                console.error("API Error:", error);
                return [];
            }
        };

        // --- CONTEXT ---
        const SettingsContext = createContext();

        const defaultBg = "https://lh3.googleusercontent.com/aida-public/AB6AXuAOrQLKRUmFQhPxWSXwhFKntvqt5JvcRPZHSGEfJ6534s7zRxMYnhaVjiPPkQb1dSZerTsg6wuTZGGxx3ldiOsjAcwCPu5eXkl9Sh31aJykos91Vq4LS-XOvIdMt9-Lk2PEZSEb3Yy8MYY89dlvY-l8Bpgmn5aJs7P3TRtrwUCaytrFFcAo64P_Bl8hcaxQGUjEsNHbGrRYLfi8MNrFtYTDY-_FVk1V8cUKnIvDDK-pdMtl2WtaznRR5qWi3vmydcqQv2gcQj8jrVk";
        
        const slideshowImages = [
            defaultBg,
            "https://lh3.googleusercontent.com/aida-public/AB6AXuAIQlg9ExURoitbx-siETAk3sji_tYFU2RD2Wb3QHdPwd1H6L68cqmXzKWR48SuW5Q1TgJGbybsbWl77ODKERMY87uU11t43rTCxDRFLaaLxIUir7qXgGhdx1vRzV902TIJpEfXx1RcIX0zVXIdFXNiLLEZOafUijcZfxhvHebu9MTR6EPT6CCadKdhe1-er33j3KC7ryz7jTrysoFFBsT_XX5k4Ny-U6lVS5v63bPOkh4wK6p1Ix4_BXrPe-AwspexXFcJIaDQFHo",
            "https://lh3.googleusercontent.com/aida-public/AB6AXuB2LoTTl_o0k-4Xw86X_LRqqxQIicJpI1M_7AHxoPXjYwPEROPNoYl6t12YQuZKgb2YJFYswu81I8cZd7OmIRIRlQCn362IBxm6m--IkVU78Ndk1m7TSXg7veU9tbE49Um5uhUTf2rGHWHfBM5g19xmfd6tq9z3iE4kO9TUZCzJR4sKlL9t5agvMP6fAgbP2dV8q8thdKo3cReM04o95GiRAw5JhKgj1cWWMj6tFTxbtNBeBwDhpACJ_4Ne5MOe79ED9n1fH_b6YTw"
        ];

        const SettingsProvider = ({ children }) => {
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('muslimProSettings');
                return saved ? JSON.parse(saved) : {
                    location: { city: "Jakarta Pusat, DKI Jakarta", lat: -6.1754, lng: 106.8272 },
                    appearance: { bgImage: defaultBg, customBg: null, slideshowActive: false, slideshowInterval: 10, opacity: 70, blur: 4 },
                    runningText: { active: true, text: "Selamat datang di Masjid Raya. Mohon nonaktifkan HP saat sholat berlangsung.", speed: 5, size: "medium" }
                };
            });

            // Live Prayer Data State
            const [todaysTimings, setTodaysTimings] = useState(null);
            const [hijriDate, setHijriDate] = useState("");

            useEffect(() => {
                localStorage.setItem('muslimProSettings', JSON.stringify(settings));
            }, [settings]);

            // Fetch timings when location changes
            useEffect(() => {
                const getTimings = async () => {
                    const data = await fetchPrayerTimesFromAPI(settings.location.lat, settings.location.lng);
                    if (data) {
                        setTodaysTimings(data.timings);
                        setHijriDate(`${data.date.hijri.day} ${data.date.hijri.month.en} ${data.date.hijri.year}`);
                    }
                };
                getTimings();
            }, [settings.location.lat, settings.location.lng]);

            const updateSettings = (section, key, value) => {
                setSettings(prev => ({ ...prev, [section]: { ...prev[section], [key]: value } }));
            };

            const handleImageUpload = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result;
                        setSettings(prev => ({
                            ...prev,
                            appearance: { ...prev.appearance, bgImage: base64String, customBg: base64String, slideshowActive: false }
                        }));
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            return (
                <SettingsContext.Provider value={{ settings, updateSettings, handleImageUpload, slideshowImages, todaysTimings, hijriDate }}>
                    {children}
                </SettingsContext.Provider>
            );
        };

        // --- COMPONENTS ---

        const ClockDisplay = memo(() => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return (
                <div className="flex flex-col items-center md:items-end text-white">
                    <div className="text-xs font-bold text-gold uppercase tracking-[0.2em] mb-1">Waktu Sekarang</div>
                    <h2 className="text-5xl md:text-6xl font-serif font-bold text-white tabular-nums drop-shadow-gold tracking-tight">
                        {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </h2>
                    <span className="text-lg font-light text-slate-200 tracking-widest">{time.toLocaleTimeString([], { second: '2-digit' })}</span>
                </div>
            );
        });

        const PrayerCountdown = memo(({ targetDate, nextPrayerName }) => {
            const [countdown, setCountdown] = useState({ h: 0, m: 0, s: 0 });

            useEffect(() => {
                if (!targetDate) return;
                const timer = setInterval(() => {
                    const now = new Date();
                    const diff = targetDate - now;
                    if (diff <= 0) {
                        setCountdown({ h: 0, m: 0, s: 0 });
                    } else {
                        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
                        const m = Math.floor((diff / (1000 * 60)) % 60);
                        const s = Math.floor((diff / 1000) % 60);
                        setCountdown({ h, m, s });
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [targetDate]);

            const fmt = (n) => String(n).padStart(2, '0');

            return (
                <div className="flex flex-col items-center">
                    <div className="text-gold text-sm font-bold uppercase tracking-widest mb-4">Menuju {nextPrayerName}</div>
                    <div className="flex gap-4 text-center">
                        <div className="flex flex-col">
                            <span className="text-4xl sm:text-5xl font-bold font-serif text-white drop-shadow-md">{fmt(countdown.h)}</span>
                            <span className="text-[10px] text-emerald-200 uppercase tracking-widest mt-1">Jam</span>
                        </div>
                        <span className="text-4xl sm:text-5xl font-serif text-gold/80 animate-pulse">:</span>
                        <div className="flex flex-col">
                            <span className="text-4xl sm:text-5xl font-bold font-serif text-white drop-shadow-md">{fmt(countdown.m)}</span>
                            <span className="text-[10px] text-emerald-200 uppercase tracking-widest mt-1">Menit</span>
                        </div>
                        <span className="text-4xl sm:text-5xl font-serif text-gold/80 animate-pulse">:</span>
                        <div className="flex flex-col">
                            <span className="text-4xl sm:text-5xl font-bold font-serif text-white drop-shadow-md">{fmt(countdown.s)}</span>
                            <span className="text-[10px] text-emerald-200 uppercase tracking-widest mt-1">Detik</span>
                        </div>
                    </div>
                </div>
            );
        });

        const PrayerCard = memo(({ name, time, active, highlightColor }) => {
            return (
                <div className={`relative overflow-hidden rounded-xl border transition-all duration-500 group ${active ? 'border-gold bg-gradient-to-b from-emerald-900/90 to-emerald-950/90 shadow-[0_0_30px_rgba(251,191,36,0.2)] scale-105 z-10' : 'border-white/10 bg-black/40 hover:bg-black/60 hover:border-white/20'}`}>
                    {active && <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-gold to-transparent"></div>}
                    <div className="p-5 flex flex-col items-center text-center relative z-10">
                        <span className={`text-sm font-bold uppercase tracking-widest mb-2 ${active ? 'text-gold' : 'text-slate-400 group-hover:text-slate-300'}`}>{name}</span>
                        <span className={`text-2xl sm:text-3xl font-serif font-bold ${active ? 'text-white' : 'text-slate-200'}`}>{time}</span>
                    </div>
                    {/* Islamic Pattern Overlay */}
                    <div className="absolute inset-0 bg-islamic-pattern opacity-5 pointer-events-none"></div>
                </div>
            );
        });

        const RunningTextBanner = memo(({ active, text, speed, size }) => {
            if (!active) return null;
            const fontSizeClass = { small: "text-sm", medium: "text-base", large: "text-lg", xl: "text-xl" }[size] || "text-base";
            const duration = 20 - (speed * 1.5); 
            return (
                <div className="fixed bottom-0 left-0 right-0 z-50 bg-emerald-950/95 backdrop-blur-md border-t border-emerald-800 h-12 flex items-center overflow-hidden shadow-2xl">
                    <div className="flex items-center justify-center bg-gold text-emerald-950 font-bold px-6 h-full shrink-0 z-10 text-sm uppercase tracking-wider shadow-lg">
                        Info Masjid
                    </div>
                    <div className="flex-1 overflow-hidden relative h-full flex items-center">
                        <div className="whitespace-nowrap absolute will-change-transform" style={{ animation: `marquee ${Math.max(5, duration)}s linear infinite`, paddingLeft: '100%' }}>
                            <span className={`${fontSizeClass} font-medium text-white tracking-wide font-arabic`}>{text}</span>
                        </div>
                    </div>
                </div>
            );
        });

        // --- PAGES ---

        const DashboardPage = () => {
            const { settings, slideshowImages, todaysTimings, hijriDate } = useContext(SettingsContext);
            const [bgImage, setBgImage] = useState(settings.appearance.bgImage);
            const [currentSlideIndex, setCurrentSlideIndex] = useState(0);
            const [nextPrayer, setNextPrayer] = useState(null);

            // Calculate next prayer based on LIVE data
            useEffect(() => {
                if (!todaysTimings) return;

                const calculateNextPrayer = () => {
                    const now = new Date();
                    const nowMinutes = now.getHours() * 60 + now.getMinutes();
                    
                    const prayerOrder = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                    let found = null;
                    let targetDate = new Date();

                    for (let name of prayerOrder) {
                        const timeStr = todaysTimings[name];
                        if (!timeStr) continue;
                        
                        const [h, m] = timeStr.split(':').map(Number);
                        const prayerMinutes = h * 60 + m;

                        if (prayerMinutes > nowMinutes) {
                            found = { name, time: timeStr };
                            targetDate.setHours(h, m, 0, 0);
                            break;
                        }
                    }

                    // If all passed, next is Fajr tomorrow
                    if (!found) {
                        found = { name: 'Fajr', time: todaysTimings['Fajr'] };
                        const [h, m] = found.time.split(':').map(Number);
                        targetDate.setDate(targetDate.getDate() + 1);
                        targetDate.setHours(h, m, 0, 0);
                    }

                    setNextPrayer({ ...found, targetDate });
                };

                calculateNextPrayer();
                const interval = setInterval(calculateNextPrayer, 60000); 
                return () => clearInterval(interval);
            }, [todaysTimings]);

            // Slideshow
            useEffect(() => {
                if (settings.appearance.slideshowActive) {
                    const images = settings.appearance.customBg ? [...slideshowImages, settings.appearance.customBg] : slideshowImages;
                    const intervalTime = settings.appearance.slideshowInterval * 60 * 1000;
                    setBgImage(images[currentSlideIndex % images.length]);
                    const interval = setInterval(() => {
                        setCurrentSlideIndex(prev => {
                            const next = (prev + 1) % images.length;
                            setBgImage(images[next]);
                            return next;
                        });
                    }, intervalTime);
                    return () => clearInterval(interval);
                } else {
                    setBgImage(settings.appearance.bgImage);
                }
            }, [settings.appearance, currentSlideIndex]);

            // Default dummy data if API not yet loaded
            const displayPrayers = todaysTimings ? [
                { name: "Subuh", time: todaysTimings.Fajr },
                { name: "Terbit", time: todaysTimings.Sunrise },
                { name: "Dzuhur", time: todaysTimings.Dhuhr },
                { name: "Ashar", time: todaysTimings.Asr },
                { name: "Maghrib", time: todaysTimings.Maghrib },
                { name: "Isya", time: todaysTimings.Isha },
            ] : [];

            return (
                <div className="relative z-10 flex min-h-screen w-full flex-col overflow-x-hidden font-display pb-16 text-white">
                    {/* Background */}
                    <div className="fixed inset-0 z-0 bg-black">
                        <div className="absolute inset-0 bg-cover bg-center transition-all duration-[2000ms]" style={{ backgroundImage: `url("${bgImage}")`, filter: `blur(${settings.appearance.blur}px)` }}></div>
                        <div className="absolute inset-0 bg-gradient-to-b from-emerald-950/80 via-emerald-900/60 to-emerald-950/90" style={{ opacity: settings.appearance.opacity / 100 }}></div>
                        <div className="absolute inset-0 bg-islamic-pattern opacity-10"></div>
                    </div>

                    <div className="relative z-10 flex flex-col min-h-screen">
                        {/* Header */}
                        <header className="w-full border-b border-white/10 bg-gradient-to-b from-emerald-950/80 to-transparent backdrop-blur-sm">
                            <div className="px-6 lg:px-12 py-5 flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center justify-center size-12 rounded-xl bg-gold/10 text-gold border border-gold/30 shadow-[0_0_15px_rgba(251,191,36,0.3)]">
                                        <span className="material-symbols-outlined text-3xl">mosque</span>
                                    </div>
                                    <div className="flex flex-col">
                                        <h2 className="text-xl font-bold tracking-tight text-white font-serif">Al-Multazam</h2>
                                        <p className="text-xs text-emerald-200 tracking-wider uppercase">Prayer Dashboard</p>
                                    </div>
                                </div>
                                <div className="hidden md:flex items-center gap-6">
                                     <nav className="flex items-center gap-6 text-sm font-medium text-emerald-100/80">
                                        <Link className="hover:text-gold transition-colors" to="/">Dashboard</Link>
                                        <Link className="hover:text-gold transition-colors" to="/schedule">Jadwal</Link>
                                        <Link className="hover:text-gold transition-colors" to="/qibla">Kiblat</Link>
                                        <Link className="hover:text-gold transition-colors" to="/dua">Doa</Link>
                                    </nav>
                                    <Link to="/settings" className="flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 hover:border-gold/50 transition-all group">
                                        <span className="material-symbols-outlined text-gold group-hover:animate-spin">settings</span>
                                        <span className="text-sm font-medium">{settings.location.city}</span>
                                    </Link>
                                </div>
                            </div>
                        </header>

                        <main className="flex-1 px-4 sm:px-8 lg:px-12 py-8 flex flex-col justify-center">
                            <div className="mx-auto max-w-7xl w-full flex flex-col gap-12">
                                
                                {/* Top Section: Date & Clock */}
                                <div className="flex flex-col md:flex-row justify-between items-center md:items-end gap-8 pb-8 border-b border-white/10">
                                    <div className="flex flex-col gap-2 text-center md:text-left">
                                        <div className="flex items-center justify-center md:justify-start gap-2 text-gold">
                                            <span className="material-symbols-outlined">calendar_month</span>
                                            <span className="text-lg font-bold tracking-widest uppercase">
                                                {new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                                            </span>
                                        </div>
                                        <p className="text-2xl font-serif text-emerald-100">{hijriDate || "Memuat Tanggal Hijriah..."}</p>
                                    </div>
                                    <ClockDisplay />
                                </div>

                                {/* Hero Section: Countdown */}
                                <div className="relative glass-panel rounded-3xl p-10 md:p-14 text-center shadow-2xl overflow-hidden group">
                                    {/* Decorative Arch */}
                                    <div className="absolute top-0 left-1/2 -translate-x-1/2 w-3/4 h-24 bg-gradient-to-b from-white/5 to-transparent rounded-b-full blur-xl pointer-events-none"></div>
                                    
                                    <div className="relative z-10 flex flex-col items-center gap-8">
                                        {nextPrayer ? (
                                            <React.Fragment>
                                                <PrayerCountdown targetDate={nextPrayer.targetDate} nextPrayerName={nextPrayer.name === 'Sunrise' ? 'Terbit' : nextPrayer.name} />
                                                <div className="flex items-center gap-3 px-6 py-2 rounded-full bg-black/30 border border-white/10 backdrop-blur-md">
                                                    <span className="text-slate-300 text-sm">Waktu Adzan:</span>
                                                    <span className="text-xl font-bold text-white font-serif">{nextPrayer.time}</span>
                                                </div>
                                            </React.Fragment>
                                        ) : (
                                            <div className="animate-pulse text-emerald-200">Menghitung waktu sholat...</div>
                                        )}
                                        
                                        <div className="flex gap-4 mt-2">
                                            <Link to="/dua" className="px-6 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-900/50 transition-all hover:-translate-y-1 flex items-center gap-2">
                                                <span className="material-symbols-outlined">menu_book</span>
                                                Baca Doa
                                            </Link>
                                        </div>
                                    </div>
                                </div>

                                {/* Prayer Cards */}
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                    {displayPrayers.map((p) => {
                                        const isNext = nextPrayer && (nextPrayer.name === p.name || (nextPrayer.name === 'Fajr' && p.name === 'Subuh') || (nextPrayer.name === 'Sunrise' && p.name === 'Terbit'));
                                        return (
                                            <PrayerCard 
                                                key={p.name}
                                                name={p.name} 
                                                time={p.time} 
                                                active={isNext}
                                            />
                                        );
                                    })}
                                </div>

                            </div>
                        </main>
                    </div>
                    <RunningTextBanner active={settings.runningText.active} text={settings.runningText.text} speed={settings.runningText.speed} size={settings.runningText.size} />
                </div>
            );
        };

        const SettingsPage = () => {
            const navigate = useNavigate();
            const { settings, updateSettings, handleImageUpload } = useContext(SettingsContext);
            const fileInputRef = useRef(null);
            const [isLoadingLocation, setIsLoadingLocation] = useState(false);

            const backgrounds = [
                { id: 'default', name: 'Masjid', url: "https://lh3.googleusercontent.com/aida-public/AB6AXuAOrQLKRUmFQhPxWSXwhFKntvqt5JvcRPZHSGEfJ6534s7zRxMYnhaVjiPPkQb1dSZerTsg6wuTZGGxx3ldiOsjAcwCPu5eXkl9Sh31aJykos91Vq4LS-XOvIdMt9-Lk2PEZSEb3Yy8MYY89dlvY-l8Bpgmn5aJs7P3TRtrwUCaytrFFcAo64P_Bl8hcaxQGUjEsNHbGrRYLfi8MNrFtYTDY-_FVk1V8cUKnIvDDK-pdMtl2WtaznRR5qWi3vmydcqQv2gcQj8jrVk" },
                { id: 'masjid1', name: 'Interior', url: "https://lh3.googleusercontent.com/aida-public/AB6AXuAIQlg9ExURoitbx-siETAk3sji_tYFU2RD2Wb3QHdPwd1H6L68cqmXzKWR48SuW5Q1TgJGbybsbWl77ODKERMY87uU11t43rTCxDRFLaaLxIUir7qXgGhdx1vRzV902TIJpEfXx1RcIX0zVXIdFXNiLLEZOafUijcZfxhvHebu9MTR6EPT6CCadKdhe1-er33j3KC7ryz7jTrysoFFBsT_XX5k4Ny-U6lVS5v63bPOkh4wK6p1Ix4_BXrPe-AwspexXFcJIaDQFHo" },
                { id: 'masjid2', name: 'Senja', url: "https://lh3.googleusercontent.com/aida-public/AB6AXuB2LoTTl_o0k-4Xw86X_LRqqxQIicJpI1M_7AHxoPXjYwPEROPNoYl6t12YQuZKgb2YJFYswu81I8cZd7OmIRIRlQCn362IBxm6m--IkVU78Ndk1m7TSXg7veU9tbE49Um5uhUTf2rGHWHfBM5g19xmfd6tq9z3iE4kO9TUZCzJR4sKlL9t5agvMP6fAgbP2dV8q8thdKo3cReM04o95GiRAw5JhKgj1cWWMj6tFTxbtNBeBwDhpACJ_4Ne5MOe79ED9n1fH_b6YTw" }
            ];

            const onFileChange = async (e) => {
                const file = e.target.files[0];
                if (file) { await handleImageUpload(file); }
            };

            const handleAutoLocation = () => {
                setIsLoadingLocation(true);
                const useMockLocation = (reason) => {
                    setTimeout(() => {
                        const mockLat = -6.1754; const mockLng = 106.8272;
                        updateSettings('location', 'lat', mockLat);
                        updateSettings('location', 'lng', mockLng);
                        updateSettings('location', 'city', "Jakarta Pusat, DKI Jakarta (Demo)");
                        setIsLoadingLocation(false);
                        alert(`Lokasi diatur ke Jakarta Pusat (Mode Demo). ${reason}`);
                    }, 1000);
                };
                if (!navigator.geolocation) { useMockLocation("Geolocation tidak didukung."); return; }
                try {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        updateSettings('location', 'lat', latitude);
                        updateSettings('location', 'lng', longitude);
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10&addressdetails=1`);
                            if (!response.ok) throw new Error("Network error");
                            const data = await response.json();
                            const city = data.address.city || data.address.town || "Lokasi Terdeteksi";
                            updateSettings('location', 'city', city);
                        } catch (error) {
                            updateSettings('location', 'city', `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                        } finally { setIsLoadingLocation(false); }
                    }, (error) => { useMockLocation("Izin ditolak atau error."); }, { enableHighAccuracy: false, timeout: 5000 });
                } catch (e) { useMockLocation("Error sistem."); }
            };

            return (
                <div className="bg-background-dark font-display min-h-screen flex flex-col text-white">
                    <header className="border-b border-white/10 px-6 py-4 bg-surface-dark flex items-center justify-between sticky top-0 z-50">
                        <h2 className="text-xl font-bold font-serif text-gold">Pengaturan</h2>
                        <Link to="/" className="text-sm font-medium hover:text-gold transition-colors">Kembali ke Dashboard</Link>
                    </header>
                    <main className="flex-1 p-6 md:p-10 max-w-4xl mx-auto w-full flex flex-col gap-8">
                        <section className="bg-surface-dark/50 border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-emerald-400 mb-4 flex items-center gap-2"><span className="material-symbols-outlined">location_on</span>Lokasi</h3>
                            <div className="flex flex-col gap-4">
                                <input className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-gold outline-none transition-colors" value={settings.location.city} onChange={(e) => updateSettings('location', 'city', e.target.value)} placeholder="Nama Kota"/>
                                <button onClick={handleAutoLocation} disabled={isLoadingLocation} className="flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-500 py-3 rounded-lg font-bold transition-all disabled:opacity-50">
                                    {isLoadingLocation ? <span className="animate-spin material-symbols-outlined">progress_activity</span> : <span className="material-symbols-outlined">my_location</span>}
                                    {isLoadingLocation ? 'Mendeteksi...' : 'Deteksi Otomatis'}
                                </button>
                            </div>
                        </section>
                         <section className="bg-surface-dark/50 border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-emerald-400 mb-4 flex items-center gap-2"><span className="material-symbols-outlined">palette</span>Tampilan</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                {backgrounds.map(bg => (
                                    <div key={bg.id} onClick={() => { updateSettings('appearance', 'bgImage', bg.url); updateSettings('appearance', 'slideshowActive', false); }} 
                                        className={`cursor-pointer rounded-lg overflow-hidden border-2 aspect-video relative group ${settings.appearance.bgImage === bg.url && !settings.appearance.slideshowActive ? 'border-gold' : 'border-transparent'}`}>
                                        <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: `url("${bg.url}")`}}></div>
                                        <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span className="text-xs font-bold">{bg.name}</span></div>
                                    </div>
                                ))}
                                <div onClick={() => fileInputRef.current.click()} className="cursor-pointer rounded-lg border-2 border-dashed border-white/20 hover:border-gold flex flex-col items-center justify-center aspect-video gap-2 transition-colors">
                                    <span className="material-symbols-outlined text-2xl">upload</span>
                                    <span className="text-xs">Upload</span>
                                    <input type="file" ref={fileInputRef} onChange={onFileChange} accept="image/*" className="hidden"/>
                                </div>
                            </div>
                        </section>
                         <section className="bg-surface-dark/50 border border-white/5 rounded-2xl p-6">
                            <h3 className="text-lg font-bold text-emerald-400 mb-4 flex items-center gap-2"><span className="material-symbols-outlined">subtitles</span>Running Text</h3>
                            <textarea className="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 focus:border-gold outline-none transition-colors h-24 mb-4" value={settings.runningText.text} onChange={(e) => updateSettings('runningText', 'text', e.target.value)}></textarea>
                            <div className="flex items-center justify-between">
                                <span className="text-sm text-slate-400">Aktifkan</span>
                                <input type="checkbox" checked={settings.runningText.active} onChange={(e) => updateSettings('runningText', 'active', e.target.checked)} className="accent-gold w-5 h-5"/>
                            </div>
                        </section>
                    </main>
                </div>
            );
        };

        // Reuse Previous Components for DuaPage, QiblaPage, MonthlySchedulePage (Simplified for brevity but assumed present)
        const DuaPage = () => { const navigate = useNavigate(); const [activeTab, setActiveTab] = useState('daily'); return (
            <div className="bg-background-dark min-h-screen text-white flex flex-col">
                <header className="p-4 border-b border-white/10 flex justify-between items-center"><h1 className="text-xl font-serif text-gold">Doa & Dzikir</h1><Link to="/" className="text-sm hover:text-gold">Kembali</Link></header>
                <main className="p-6 max-w-3xl mx-auto w-full">
                    <div className="flex gap-2 mb-6"><button onClick={()=>setActiveTab('daily')} className={`flex-1 py-2 rounded-lg font-medium ${activeTab==='daily'?'bg-emerald-600 text-white':'bg-white/5'}`}>Harian</button><button onClick={()=>setActiveTab('ai')} className={`flex-1 py-2 rounded-lg font-medium ${activeTab==='ai'?'bg-emerald-600 text-white':'bg-white/5'}`}>AI Finder ✨</button></div>
                    {activeTab === 'ai' ? <AIDuaGenerator/> : (
                        <div className="bg-surface-dark border border-white/5 rounded-xl p-6 text-center">
                            <h2 className="font-arabic text-3xl mb-4">اللَّهُمَّ رَبَّ هَذِهِ الدَّعْوَةِ التَّامَّةِ...</h2>
                            <p className="text-emerald-400 italic mb-2">Allahumma Rabba hadzihid-da'watit-tammah...</p>
                            <p className="text-slate-300 text-sm">"Ya Allah, Tuhan yang memiliki panggilan ini..."</p>
                        </div>
                    )}
                </main>
            </div>
        )};

        const QiblaPage = () => { const navigate = useNavigate(); return (
             <div className="bg-background-dark min-h-screen text-white flex flex-col items-center justify-center relative">
                <Link to="/" className="absolute top-6 left-6 z-10 text-sm hover:text-gold flex items-center gap-1"><span className="material-symbols-outlined">arrow_back</span>Kembali</Link>
                <div className="relative size-80 flex items-center justify-center">
                    <div className="absolute inset-0 border-4 border-white/10 rounded-full"></div>
                    <div className="absolute top-0 text-red-500 font-bold">N</div>
                    <div className="w-1 h-32 bg-gradient-to-t from-gold to-transparent absolute bottom-1/2 origin-bottom rotate-[295deg]"></div>
                    <span className="material-symbols-outlined text-4xl text-gold absolute" style={{transform: 'rotate(295deg) translateY(-140px)'}}>kaaba</span>
                    <div className="text-center mt-96"><h2 className="text-2xl font-serif text-gold">295°</h2><p className="text-slate-400 text-sm">Arah Kiblat dari Jakarta</p></div>
                </div>
            </div>
        )};

        const MonthlySchedulePage = () => { const navigate = useNavigate(); return (
            <div className="bg-background-dark min-h-screen text-white p-6">
                <header className="flex justify-between items-center mb-8"><h1 className="text-xl font-serif text-gold">Jadwal Bulanan</h1><Link to="/" className="text-sm hover:text-gold">Kembali</Link></header>
                <div className="bg-surface-dark border border-white/5 rounded-xl overflow-hidden"><div className="p-4 text-center text-slate-400">Jadwal lengkap bulan ini akan tampil disini sesuai lokasi.</div></div>
            </div>
        )};

        const App = () => {
            return (
                <SettingsProvider>
                    <MemoryRouter>
                        <Routes>
                            <Route path="/" element={<DashboardPage />} />
                            <Route path="/dua" element={<DuaPage />} />
                            <Route path="/settings" element={<SettingsPage />} />
                            <Route path="/schedule" element={<MonthlySchedulePage />} />
                            <Route path="/qibla" element={<QiblaPage />} />
                        </Routes>
                    </MemoryRouter>
                </SettingsProvider>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
