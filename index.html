<!DOCTYPE html>
<html class="dark" lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>MuslimPro Dashboard - V5 Pro</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Scheherazade+New:wght@400;700&family=Orbitron:wght@400;700&family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet"/>
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <!-- LOAD SCRIPT -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--color-primary)',
                        secondary: 'var(--color-secondary)',
                        accent: 'var(--color-accent)',
                        gold: 'var(--color-accent)',
                        "background-dark": 'var(--color-bg)', 
                        "surface-dark": 'var(--color-surface)',
                        "text-main": 'var(--color-text)',
                        "text-muted": 'var(--color-text-muted)',
                    },
                    fontFamily: {
                        "display": ['var(--font-body)', "sans-serif"],
                        "arabic": ["Amiri", "serif"],
                        "calligraphy": ['var(--font-heading)', "serif"], 
                        "quran": ["Scheherazade New", "serif"],
                    },
                    animation: {
                        'marquee': 'marquee 30s linear infinite',
                        'fade-in': 'fadeIn 0.8s ease-out',
                        'float': 'float 6s ease-in-out infinite',
                        'spin-slow': 'spin 60s linear infinite',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            overflow: hidden; 
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* --- THEME DEFINITIONS --- */
        :root {
            /* Default: Royal Gold */
            --color-bg: #050e11;
            --color-surface: rgba(6, 78, 59, 0.85);
            --color-primary: #10b981;
            --color-secondary: #064e3b;
            --color-accent: #D4AF37; /* Gold */
            --color-text: #f1f5f9;
            --color-text-muted: #94a3b8;
            --font-heading: 'Aref Ruqaa';
            --font-body: 'Plus Jakarta Sans';
            --glass-border: rgba(212, 175, 55, 0.2);
            --pattern-opacity: 0.3;
        }

        /* Theme: Classic Green */
        body.theme-classic-green {
            --color-bg: #022c22;
            --color-surface: rgba(20, 83, 45, 0.9);
            --color-primary: #4ade80;
            --color-secondary: #14532d;
            --color-accent: #22c55e;
            --font-heading: 'Amiri';
            --glass-border: rgba(34, 197, 94, 0.3);
        }

        /* Theme: Modern Neon */
        body.theme-modern-neon {
            --color-bg: #000000;
            --color-surface: rgba(20, 20, 20, 0.95);
            --color-primary: #06b6d4;
            --color-secondary: #083344;
            --color-accent: #00f3ff;
            --color-text: #e0f2fe;
            --font-heading: 'Orbitron';
            --font-body: 'Plus Jakarta Sans';
            --glass-border: rgba(6, 182, 212, 0.5);
            --pattern-opacity: 0.1;
        }

        /* Theme: Clean Minimal */
        body.theme-clean-minimal {
            --color-bg: #f8fafc;
            --color-surface: rgba(255, 255, 255, 0.9);
            --color-primary: #0f172a;
            --color-secondary: #e2e8f0;
            --color-accent: #0f172a;
            --color-text: #0f172a;
            --color-text-muted: #64748b;
            --font-heading: 'Lato';
            --font-body: 'Lato';
            --glass-border: rgba(15, 23, 42, 0.1);
            --pattern-opacity: 0.05;
        }

        /* Theme: Nature Earth */
        body.theme-nature-earth {
            --color-bg: #292524;
            --color-surface: rgba(68, 64, 60, 0.9);
            --color-primary: #d6d3d1;
            --color-secondary: #44403c;
            --color-accent: #ea580c;
            --color-text: #fafaf9;
            --font-heading: 'Cinzel';
            --glass-border: rgba(234, 88, 12, 0.3);
        }

        /* Theme: Ocean Blue */
        body.theme-ocean-blue {
            --color-bg: #0c4a6e;
            --color-surface: rgba(12, 74, 110, 0.9);
            --color-primary: #38bdf8;
            --color-secondary: #075985;
            --color-accent: #7dd3fc;
            --font-heading: 'Plus Jakarta Sans';
            --glass-border: rgba(125, 211, 252, 0.3);
        }

        .islamic-pattern {
            background-color: transparent;
            background-image: radial-gradient(circle at 50% 50%, var(--color-accent) 0%, transparent 80%), 
                              url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23888888' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .mihrab-shape {
            border-radius: 100px 100px 10px 10px;
            border: 1px solid var(--color-accent); 
        }

        body.theme-clean-minimal .mihrab-shape,
        body.theme-modern-neon .mihrab-shape {
            border-radius: 16px;
        }

        .glass-panel {
            background: var(--color-surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--color-accent); border-radius: 4px; }
        
        .text-shadow-glow { text-shadow: 0 0 10px var(--color-accent); }
    </style>
</head>
<body class="bg-background-dark text-text-main transition-colors duration-500">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, memo, useContext, useRef, createContext } = React;
        const { createRoot } = ReactDOM;
        const { HashRouter, Routes, Route, Link, useNavigate } = ReactRouterDOM;

        // --- UTILITIES ---
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);

        const compressImage = (file, maxWidth = 1280, quality = 0.6) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const elem = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }
                        elem.width = width;
                        elem.height = height;
                        const ctx = elem.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(ctx.canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const adjustTime = (timeStr, minutesToAdd) => {
            if (!timeStr) return "";
            const [h, m] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(h, m + (minutesToAdd || 0));
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        };

        const PrayerCalc = {
            d2r: (d) => d * Math.PI / 180.0,
            r2d: (r) => r * 180.0 / Math.PI,
            fixHour: (a) => { a = a - 24.0 * Math.floor(a / 24.0); a = a < 0 ? a + 24.0 : a; return a; },
            sunPosition: (jd) => {
                const D = jd - 2451545.0;
                const g = PrayerCalc.fixHour(357.529 + 0.98560028 * D);
                const q = PrayerCalc.fixHour(280.459 + 0.98564736 * D);
                const L = PrayerCalc.fixHour(q + 1.915 * Math.sin(PrayerCalc.d2r(g)) + 0.020 * Math.sin(PrayerCalc.d2r(2 * g)));
                const e = 23.439 - 0.00000036 * D;
                const RA = PrayerCalc.r2d(Math.atan2(Math.cos(PrayerCalc.d2r(e)) * Math.sin(PrayerCalc.d2r(L)), Math.cos(PrayerCalc.d2r(L)))) / 15.0;
                const RA_L = PrayerCalc.fixHour(L / 15.0);
                const RA_final = PrayerCalc.fixHour(RA + (RA_L - PrayerCalc.fixHour(RA))); 
                const Decl = PrayerCalc.r2d(Math.asin(Math.sin(PrayerCalc.d2r(e)) * Math.sin(PrayerCalc.d2r(L))));
                const EqT = q / 15.0 - RA_final;
                return { declination: Decl, equation: EqT };
            },
            getTimes: (date, lat, lng, timeZone, offsets = {}, method = 20) => {
                let year = date.getFullYear(), month = date.getMonth() + 1, day = date.getDate();
                if (month <= 2) { year -= 1; month += 12; }
                const A = Math.floor(year / 100);
                const B = 2 - A + Math.floor(A / 4);
                const JD = Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + B - 1524.5;
                const sun = PrayerCalc.sunPosition(JD);
                const D = sun.declination;
                const EqT = sun.equation;
                
                let fajrAngle = 20; 
                let ishaAngle = 18;
                if (method === 'muhammadiyah') { fajrAngle = 18; ishaAngle = 18; }

                const computeTime = (angle, mode) => {
                   const P1 = -Math.sin(PrayerCalc.d2r(angle)) - Math.sin(PrayerCalc.d2r(lat)) * Math.sin(PrayerCalc.d2r(D));
                   const P2 = Math.cos(PrayerCalc.d2r(lat)) * Math.cos(PrayerCalc.d2r(D));
                   return PrayerCalc.r2d(Math.acos(P1 / P2) / 15.0); 
                };
                const dhuhr = 12 + EqT - lng / 15;
                const sunAngleTime = computeTime(0.833, 0); 
                const sunrise = dhuhr - sunAngleTime;
                const sunset = dhuhr + sunAngleTime;
                const fajr = dhuhr - computeTime(fajrAngle, 1);
                const isha = dhuhr + computeTime(ishaAngle, 1);
                const asrAngle = Math.atan(1 / (1 + Math.tan(PrayerCalc.d2r(Math.abs(lat - D)))));
                const asr = dhuhr + PrayerCalc.r2d(Math.acos((Math.sin(asrAngle) - Math.sin(PrayerCalc.d2r(lat)) * Math.sin(PrayerCalc.d2r(D))) / (Math.cos(PrayerCalc.d2r(lat)) * Math.cos(PrayerCalc.d2r(D))))) / 15.0;
                
                const format = (t, correction = 0) => {
                    const time = PrayerCalc.fixHour(t + timeZone);
                    const hours = Math.floor(time);
                    const minutes = Math.floor((time - hours) * 60);
                    const d = new Date();
                    d.setHours(hours, minutes + (correction || 0), 0); 
                    return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                };
                return {
                    Fajr: format(fajr, offsets.Fajr), Sunrise: format(sunrise, offsets.Sunrise), Dhuhr: format(dhuhr, offsets.Dhuhr),
                    Asr: format(asr, offsets.Asr), Maghrib: format(sunset, offsets.Maghrib), Isha: format(isha, offsets.Isha)
                };
            }
        };

        const fetchPrayerTimesFromAPI = async (lat, lng, offsets, method = 20) => {
            try {
                if (method === 'muhammadiyah') return null; 
                const response = await fetch(`https://api.aladhan.com/v1/timings/${Math.floor(Date.now() / 1000)}?latitude=${lat}&longitude=${lng}&method=${method}`); 
                if (!response.ok) throw new Error("Failed to fetch prayer times");
                const data = await response.json();
                const timings = data.data.timings;
                const correctedTimings = {
                    Fajr: adjustTime(timings.Fajr, offsets.Fajr),
                    Sunrise: adjustTime(timings.Sunrise, offsets.Sunrise),
                    Dhuhr: adjustTime(timings.Dhuhr, offsets.Dhuhr),
                    Asr: adjustTime(timings.Asr, offsets.Asr),
                    Maghrib: adjustTime(timings.Maghrib, offsets.Maghrib),
                    Isha: adjustTime(timings.Isha, offsets.Isha)
                };
                return { ...data.data, timings: correctedTimings }; 
            } catch (error) {
                console.log("API Error, switching to offline calc");
                return null;
            }
        };

        // --- DATA THEMES ---
        const THEMES = [
            { id: 'royal-gold', name: 'Royal Gold', icon: 'crown', color: '#D4AF37', desc: 'Mewah & Klasik' },
            { id: 'classic-green', name: 'Classic Green', icon: 'mosque', color: '#22c55e', desc: 'Hijau Masjid' },
            { id: 'modern-neon', name: 'Modern Neon', icon: 'bolt', color: '#00f3ff', desc: 'Futuristik Gelap' },
            { id: 'clean-minimal', name: 'Clean Minimal', icon: 'check_circle', color: '#f8fafc', textColor: '#000', desc: 'Terang & Bersih' },
            { id: 'nature-earth', name: 'Nature Earth', icon: 'forest', color: '#ea580c', desc: 'Hangat & Alami' },
            { id: 'ocean-blue', name: 'Ocean Blue', icon: 'water_drop', color: '#38bdf8', desc: 'Biru Tenang' },
        ];

        // --- CONTEXT ---
        const SettingsContext = createContext();

        const SettingsProvider = ({ children }) => {
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('muslimProSettings_v5');
                const defaultSettings = {
                    general: { mosqueName: "Masjid Al-Multazam", method: 20, iqamahDelay: 10, prayerDuration: 10, hijriAdjustment: 0 },
                    location: { city: "Jakarta Pusat", lat: -6.1754, lng: 106.8272, manual: false },
                    offsets: { Fajr: 2, Sunrise: -2, Dhuhr: 2, Asr: 2, Maghrib: 2, Isha: 2 },
                    runningText: { active: true, texts: ["Luruskan dan rapatkan shaf.", "Matikan alat komunikasi.", "Jagalah kebersihan masjid."] },
                    appearance: { 
                        theme: 'royal-gold', 
                        bgImage: "https://images.unsplash.com/photo-1519817650390-64a93db51149?q=80&w=2574&auto=format&fit=crop" 
                    },
                    financials: { balance: 15000000, income: 2500000, expense: 1000000 },
                    slides: []
                };
                return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
            });

            const [todaysTimings, setTodaysTimings] = useState(null);
            const [hijriDate, setHijriDate] = useState("");

            // Apply Theme
            useEffect(() => {
                const themeId = settings.appearance.theme || 'royal-gold';
                document.body.className = `bg-background-dark text-text-main transition-colors duration-500 theme-${themeId}`;
            }, [settings.appearance.theme]);

            // Save Settings
            useEffect(() => {
                localStorage.setItem('muslimProSettings_v5', JSON.stringify(settings));
            }, [settings]);

            // Calculate Prayer Times
            useEffect(() => {
                const getTimings = async () => {
                    const lat = parseFloat(settings.location.lat);
                    const lng = parseFloat(settings.location.lng);
                    const method = settings.general.method; 
                    
                    if (navigator.onLine && method !== 'muhammadiyah') {
                        const data = await fetchPrayerTimesFromAPI(lat, lng, settings.offsets, method);
                        if (data) {
                            setTodaysTimings(data.timings);
                            return;
                        }
                    }
                    const today = new Date();
                    const tzOffset = -today.getTimezoneOffset() / 60; 
                    const timings = PrayerCalc.getTimes(today, lat, lng, tzOffset, settings.offsets, method);
                    setTodaysTimings(timings);
                };
                getTimings();
            }, [settings.location, settings.offsets, settings.general.method]);

            // Hijri Date
            useEffect(() => {
                if (!todaysTimings) return;
                const updateHijri = () => {
                    const now = new Date();
                    const [h, m] = todaysTimings.Maghrib.split(':').map(Number);
                    const maghribTime = new Date();
                    maghribTime.setHours(h, m, 0, 0);

                    const hijriBaseDate = new Date();
                    if (now >= maghribTime) hijriBaseDate.setDate(hijriBaseDate.getDate() + 1);
                    hijriBaseDate.setDate(hijriBaseDate.getDate() + (settings.general.hijriAdjustment || 0));

                    const formatted = new Intl.DateTimeFormat('id-TN-u-ca-islamic', {
                        day: 'numeric', month: 'long', year: 'numeric'
                    }).format(hijriBaseDate);
                    setHijriDate(formatted);
                };
                updateHijri();
                const interval = setInterval(updateHijri, 60000);
                return () => clearInterval(interval);
            }, [todaysTimings, settings.general.hijriAdjustment]);

            const updateSettings = (section, key, value) => {
                setSettings(prev => {
                    if(section === 'root') return { ...prev, [key]: value };
                    return { ...prev, [section]: { ...prev[section], [key]: value } };
                });
            };

            const handleImageUpload = async (file, type = 'bg') => {
                try {
                    const compressed = await compressImage(file);
                    if (type === 'bg') {
                        updateSettings('appearance', 'bgImage', compressed);
                    } else if (type === 'slide') {
                        const newSlides = [...(settings.slides || []), { type: 'image', url: compressed, duration: 10 }];
                        updateSettings('slides', 'value', newSlides); // Special logic needed
                        // Since 'slides' is root level in my previous logic but treated as nested, let's fix:
                        setSettings(prev => ({ ...prev, slides: newSlides }));
                    }
                } catch (e) { alert("Gagal proses gambar. Coba ukuran lebih kecil."); }
            };

            return (
                <SettingsContext.Provider value={{ settings, updateSettings, todaysTimings, hijriDate, handleImageUpload }}>
                    {children}
                </SettingsContext.Provider>
            );
        };

        // --- COMPONENTS ---

        const ClockWidget = memo(() => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return (
                <div className="flex flex-col items-center justify-center relative animate-fade-in">
                    <div className="absolute inset-0 border-2 border-accent/20 rounded-full animate-spin-slow"></div>
                    <div className="text-accent font-bold tracking-widest uppercase text-xs mb-2">Waktu Saat Ini</div>
                    <div className="font-calligraphy text-7xl md:text-9xl text-text-main drop-shadow-xl leading-none">
                        {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
                    </div>
                    <div className="text-text-muted font-display text-xl tracking-[0.5em] mt-2">
                        {time.toLocaleTimeString([], { second: '2-digit' })}
                    </div>
                </div>
            );
        });

        const PrayerCard = memo(({ name, time, active, arabicName }) => {
            return (
                <div className={`relative group transition-all duration-500 transform ${active ? 'scale-110 z-10 -translate-y-2' : 'hover:-translate-y-1'}`}>
                    <div className={`
                        mihrab-shape overflow-hidden relative flex flex-col items-center justify-center pt-8 pb-4 px-2
                        ${active 
                            ? 'bg-accent/10 border-accent shadow-[0_0_30px_rgba(var(--color-accent),0.3)]' 
                            : 'bg-surface-dark border-white/5'}
                        backdrop-blur-sm transition-colors duration-500
                    `}>
                        <div className="absolute top-2 opacity-10 text-4xl font-quran text-accent">{arabicName}</div>
                        <div className="relative z-10 text-center">
                            <h3 className={`font-calligraphy text-2xl mb-1 ${active ? 'text-accent' : 'text-text-muted'}`}>{name}</h3>
                            <div className={`h-px w-12 mx-auto mb-2 ${active ? 'bg-accent' : 'bg-white/10'}`}></div>
                            <p className={`font-display text-3xl font-bold ${active ? 'text-text-main text-shadow-glow' : 'text-text-main'}`}>{time || "--:--"}</p>
                        </div>
                        {active && <div className="absolute bottom-2 w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></div>}
                    </div>
                </div>
            );
        });

        const RunningText = memo(({ texts }) => (
            <div className="fixed bottom-0 w-full h-12 bg-surface-dark border-t border-accent/30 backdrop-blur-md flex items-center overflow-hidden z-50">
                <div className="bg-accent text-background-dark px-6 h-full flex items-center justify-center font-bold tracking-widest uppercase text-xs shadow-lg relative z-20">
                    Info
                </div>
                <div className="w-0 h-0 border-l-[10px] border-l-accent border-t-[10px] border-t-transparent border-b-[10px] border-b-transparent relative z-20"></div>
                <div className="flex-1 overflow-hidden relative h-full flex items-center">
                     <div className="whitespace-nowrap absolute animate-marquee flex gap-16">
                        {(texts || []).map((t, i) => (
                            <span key={i} className="text-lg font-calligraphy text-text-main flex items-center gap-4">
                                <span className="text-accent text-xs">◆</span> {t}
                            </span>
                        ))}
                         {(texts || []).map((t, i) => ( 
                            <span key={`dup-${i}`} className="text-lg font-calligraphy text-text-main flex items-center gap-4">
                                <span className="text-accent text-xs">◆</span> {t}
                            </span>
                        ))}
                    </div>
                </div>
            </div>
        ));

        // --- DASHBOARD ---
        const Dashboard = () => {
            const { settings, todaysTimings, hijriDate } = useContext(SettingsContext);
            const [nextPrayer, setNextPrayer] = useState(null);
            
            // Logic Slideshow
            const [slideIndex, setSlideIndex] = useState(-1); // -1 = Main, 0..N = Slide
            const slides = settings.slides || [];

            useEffect(() => {
                if(!todaysTimings) return;
                const now = new Date();
                const nowStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
                const order = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                let found = null;
                for(let p of order) {
                    if(nowStr < todaysTimings[p]) { found = p; break; }
                }
                setNextPrayer(found || 'Fajr');
            }, [todaysTimings]);

            // Slideshow Timer
            useEffect(() => {
                const duration = slideIndex === -1 ? 30000 : 10000; // 30s Main, 10s Slides
                const timer = setTimeout(() => {
                    setSlideIndex(prev => {
                        if (slides.length === 0) return -1;
                        if (prev >= slides.length - 1) return -1;
                        return prev + 1;
                    });
                }, duration);
                return () => clearTimeout(timer);
            }, [slideIndex, slides.length]);

            // Financial Footer Rotator
            const [finIndex, setFinIndex] = useState(0);
            useEffect(() => {
                const timer = setInterval(() => setFinIndex(p => (p + 1) % 3), 5000);
                return () => clearInterval(timer);
            }, []);

            const prayerList = [
                { id: 'Fajr', name: 'Subuh', arabic: 'الفجر' },
                { id: 'Sunrise', name: 'Syuruq', arabic: 'الشروق' },
                { id: 'Dhuhr', name: 'Dzuhur', arabic: 'الظهر' },
                { id: 'Asr', name: 'Ashar', arabic: 'العصر' },
                { id: 'Maghrib', name: 'Maghrib', arabic: 'المغرب' },
                { id: 'Isha', name: 'Isya', arabic: 'العشاء' },
            ];

            return (
                <div className="relative h-screen w-full overflow-hidden bg-background-dark text-text-main">
                    {/* Background */}
                    <div className="absolute inset-0 z-0">
                        <div className="absolute inset-0 bg-cover bg-center transition-all duration-1000 scale-105" 
                             style={{ backgroundImage: `url("${settings.appearance.bgImage}")` }}></div>
                        <div className="absolute inset-0 bg-background-dark/70 transition-colors duration-500"></div> 
                        <div className="absolute inset-0 islamic-pattern opacity-30"></div>
                    </div>

                    <div className="relative z-10 flex flex-col h-full p-6 md:p-8 pb-16">
                        <header className="flex justify-between items-start mb-4">
                            <div className="flex flex-col">
                                <div className="text-accent font-quran text-lg mb-1">{hijriDate || "Memuat..."}</div>
                                <h1 className="text-3xl md:text-5xl font-calligraphy text-text-main drop-shadow-md">{settings.general.mosqueName}</h1>
                                <div className="flex items-center gap-2 text-text-muted text-sm mt-1">
                                    <span className="material-symbols-outlined text-sm">location_on</span>
                                    {settings.location.city}
                                </div>
                            </div>
                            <div className="hidden md:block font-quran text-3xl text-accent opacity-90">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيم</div>
                        </header>

                        {/* MAIN CONTENT AREA: SWITCH BETWEEN CLOCK AND SLIDES */}
                        <main className="flex-1 flex flex-col justify-center items-center gap-8 min-h-0 relative">
                            {slideIndex === -1 ? (
                                <div className="flex flex-col items-center w-full animate-fade-in gap-8">
                                    <div className="animate-float"><ClockWidget /></div>
                                    <div className="w-full max-w-7xl grid grid-cols-3 md:grid-cols-6 gap-3 md:gap-6 mt-8">
                                        {prayerList.map((p) => (
                                            <PrayerCard 
                                                key={p.id} 
                                                name={p.name} 
                                                arabicName={p.arabic} 
                                                time={todaysTimings ? todaysTimings[p.id] : "--:--"} 
                                                active={p.id === nextPrayer} 
                                            />
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="w-full h-full flex items-center justify-center animate-fade-in p-4">
                                    <img 
                                        src={slides[slideIndex].url} 
                                        className="max-h-full max-w-full object-contain rounded-2xl shadow-2xl border border-accent/20"
                                        alt="Slide"
                                    />
                                </div>
                            )}
                        </main>

                        <footer className="mt-auto grid grid-cols-1 md:grid-cols-3 gap-4 h-32">
                            <div className="md:col-span-2 glass-panel rounded-2xl p-4 flex items-center gap-4 mihrab-shape !rounded-xl !border-l-4 !border-l-accent">
                                <div className="bg-accent/10 p-3 rounded-full text-accent border border-accent/30">
                                    <span className="material-symbols-outlined text-3xl">format_quote</span>
                                </div>
                                <div>
                                    <h4 className="text-accent font-calligraphy text-lg mb-1">Hadits</h4>
                                    <p className="text-text-muted text-sm italic leading-relaxed">"Sebaik-baik kalian adalah orang yang belajar Al-Qur'an dan mengajarkannya."</p>
                                    <span className="text-xs text-text-muted mt-1 block">— HR. Bukhari</span>
                                </div>
                            </div>
                            
                            {/* FINANCIAL WIDGET ROTATOR */}
                            <div className="glass-panel rounded-2xl p-4 flex flex-col justify-center mihrab-shape !rounded-xl relative overflow-hidden">
                                {finIndex === 0 && (
                                    <div className="flex flex-col animate-slide-up h-full justify-center">
                                        <div className="flex items-center gap-2 text-accent mb-2 border-b border-text-muted/10 pb-2">
                                            <span className="material-symbols-outlined">account_balance_wallet</span>
                                            <span className="font-calligraphy text-lg">Saldo Kas</span>
                                        </div>
                                        <span className="text-2xl font-display font-bold text-text-main">{formatRupiah(settings.financials.balance)}</span>
                                    </div>
                                )}
                                {finIndex === 1 && (
                                    <div className="flex flex-col animate-slide-up h-full justify-center">
                                        <div className="flex items-center gap-2 text-green-400 mb-2 border-b border-text-muted/10 pb-2">
                                            <span className="material-symbols-outlined">arrow_downward</span>
                                            <span className="font-calligraphy text-lg">Pemasukan</span>
                                        </div>
                                        <span className="text-2xl font-display font-bold text-text-main">{formatRupiah(settings.financials.income)}</span>
                                    </div>
                                )}
                                {finIndex === 2 && (
                                    <div className="flex flex-col animate-slide-up h-full justify-center">
                                        <div className="flex items-center gap-2 text-red-400 mb-2 border-b border-text-muted/10 pb-2">
                                            <span className="material-symbols-outlined">arrow_upward</span>
                                            <span className="font-calligraphy text-lg">Pengeluaran</span>
                                        </div>
                                        <span className="text-2xl font-display font-bold text-text-main">{formatRupiah(settings.financials.expense)}</span>
                                    </div>
                                )}
                                <div className="flex gap-1 mt-2 justify-center">
                                    <div className={`h-1 w-4 rounded-full ${finIndex===0?'bg-accent':'bg-white/10'}`}></div>
                                    <div className={`h-1 w-4 rounded-full ${finIndex===1?'bg-accent':'bg-white/10'}`}></div>
                                    <div className={`h-1 w-4 rounded-full ${finIndex===2?'bg-accent':'bg-white/10'}`}></div>
                                </div>
                            </div>
                        </footer>
                    </div>

                    <RunningText texts={settings.runningText.texts} />
                    <Link to="/settings" className="fixed top-4 right-4 z-50 p-2 text-white/20 hover:text-accent transition-colors"><span className="material-symbols-outlined">settings</span></Link>
                </div>
            );
        };

        // --- SETTINGS PAGE ---
        const SettingsPage = () => {
            const navigate = useNavigate();
            const { settings, updateSettings, handleImageUpload } = useContext(SettingsContext);
            const [isLoadingLoc, setIsLoadingLoc] = useState(false);
            const [searchQuery, setSearchQuery] = useState("");
            const [searchStatus, setSearchStatus] = useState("");
            const [newRunText, setNewRunText] = useState("");
            const slideInputRef = useRef(null);
            const bgInputRef = useRef(null);

            const handleAutoLocation = () => { /* ... existing logic ... */ };
            const handleManualSearch = async () => { /* ... existing logic ... */ };

            const addRunText = () => {
                if (newRunText) {
                    updateSettings('runningText', 'texts', [...(settings.runningText.texts||[]), newRunText]);
                    setNewRunText("");
                }
            };

            const removeSlide = (index) => {
                const newSlides = settings.slides.filter((_, i) => i !== index);
                setSettings(prev => ({ ...prev, slides: newSlides })); // Direct set for array
            };

            return (
                <div className="bg-background-dark font-display h-screen flex flex-col text-text-main overflow-hidden transition-colors duration-500">
                    <header className="border-b border-accent/20 px-6 py-4 bg-surface-dark flex items-center justify-between shrink-0">
                        <h2 className="text-xl font-bold font-calligraphy text-accent">Pengaturan Dashboard</h2>
                        <button onClick={() => navigate('/')} className="text-sm font-bold bg-accent hover:bg-white text-background-dark px-4 py-2 rounded-lg transition-colors">Simpan & Kembali</button>
                    </header>
                    <main className="flex-1 overflow-y-auto p-6 md:p-10 w-full">
                        <div className="max-w-5xl mx-auto flex flex-col gap-8 pb-10">
                            
                            {/* THEME SELECTOR */}
                            <section className="glass-panel rounded-2xl p-6 border-l-4 border-l-accent">
                                <h3 className="text-lg font-bold text-accent mb-4 flex items-center gap-2"><span className="material-symbols-outlined">palette</span>Tampilan & Background</h3>
                                <div className="flex gap-4 items-center mb-6">
                                    <div onClick={() => bgInputRef.current.click()} className="flex-1 cursor-pointer bg-black/20 border border-dashed border-accent/30 hover:border-accent p-4 rounded-xl flex items-center justify-center gap-2 text-text-muted hover:text-accent transition-colors">
                                        <span className="material-symbols-outlined">image</span> Ganti Background Masjid
                                    </div>
                                    <input type="file" ref={bgInputRef} className="hidden" accept="image/*" onChange={e => handleImageUpload(e.target.files[0], 'bg')} />
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    {THEMES.map(theme => (
                                        <button key={theme.id} onClick={() => updateSettings('appearance', 'theme', theme.id)} className={`relative overflow-hidden rounded-xl p-4 border-2 text-left transition-all duration-300 flex flex-col gap-2 group ${settings.appearance.theme === theme.id ? 'border-accent bg-accent/10' : 'border-white/10 hover:border-accent/50 bg-black/20'}`}>
                                            <div className="flex justify-between items-center">
                                                <span className="material-symbols-outlined text-2xl" style={{color: theme.color}}>{theme.icon}</span>
                                                {settings.appearance.theme === theme.id && <span className="material-symbols-outlined text-accent">check_circle</span>}
                                            </div>
                                            <h4 className="font-bold text-sm mt-1" style={{color: settings.appearance.theme === 'clean-minimal' && theme.id === 'clean-minimal' ? '#000' : 'var(--text-main)'}}>{theme.name}</h4>
                                            <div className="absolute bottom-0 left-0 w-full h-1" style={{backgroundColor: theme.color}}></div>
                                        </button>
                                    ))}
                                </div>
                            </section>

                            {/* SLIDESHOW MANAGER */}
                            <section className="glass-panel rounded-2xl p-6 border-l-4 border-l-accent">
                                <h3 className="text-lg font-bold text-accent mb-4 flex items-center gap-2"><span className="material-symbols-outlined">collections</span>Mading Digital (Slideshow)</h3>
                                <div className="flex flex-col gap-4">
                                    <div onClick={() => slideInputRef.current.click()} className="cursor-pointer bg-accent/10 border border-dashed border-accent hover:bg-accent/20 p-6 rounded-xl flex flex-col items-center justify-center text-accent transition-colors">
                                        <span className="material-symbols-outlined text-3xl mb-1">add_photo_alternate</span>
                                        <span className="font-bold">Tambah Poster / Gambar</span>
                                        <span className="text-xs opacity-70">Otomatis masuk rotasi slide</span>
                                    </div>
                                    <input type="file" ref={slideInputRef} className="hidden" accept="image/*" onChange={e => handleImageUpload(e.target.files[0], 'slide')} />
                                    
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {(settings.slides || []).map((slide, idx) => (
                                            <div key={idx} className="relative group rounded-lg overflow-hidden border border-white/10">
                                                <img src={slide.url} className="w-full h-32 object-cover" />
                                                <button onClick={() => removeSlide(idx)} className="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <span className="material-symbols-outlined text-sm">close</span>
                                                </button>
                                                <div className="absolute bottom-0 w-full bg-black/50 text-white text-[10px] p-1 text-center">10 Detik</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </section>

                            {/* FINANCIALS */}
                            <section className="glass-panel rounded-2xl p-6 border-l-4 border-l-accent">
                                <h3 className="text-lg font-bold text-accent mb-4 flex items-center gap-2"><span className="material-symbols-outlined">payments</span>Laporan Keuangan</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <label className="flex flex-col gap-1"><span className="text-sm text-text-muted">Saldo Akhir (Rp)</span><input type="number" className="bg-black/20 border border-accent/30 rounded px-3 py-2 focus:border-accent outline-none text-text-main" value={settings.financials.balance} onChange={e=>updateSettings('financials','balance',parseInt(e.target.value)||0)}/></label>
                                    <label className="flex flex-col gap-1"><span className="text-sm text-text-muted">Pemasukan (Jumat/Infak)</span><input type="number" className="bg-black/20 border border-accent/30 rounded px-3 py-2 focus:border-accent outline-none text-text-main" value={settings.financials.income} onChange={e=>updateSettings('financials','income',parseInt(e.target.value)||0)}/></label>
                                    <label className="flex flex-col gap-1"><span className="text-sm text-text-muted">Pengeluaran</span><input type="number" className="bg-black/20 border border-accent/30 rounded px-3 py-2 focus:border-accent outline-none text-text-main" value={settings.financials.expense} onChange={e=>updateSettings('financials','expense',parseInt(e.target.value)||0)}/></label>
                                </div>
                            </section>

                            {/* RUNNING TEXT */}
                            <section className="glass-panel rounded-2xl p-6 border-l-4 border-l-accent">
                                <h3 className="text-lg font-bold text-accent mb-4 flex items-center gap-2"><span className="material-symbols-outlined">edit_note</span>Running Text</h3>
                                <div className="flex gap-2 mb-4">
                                    <input className="flex-1 bg-black/20 border border-accent/30 rounded px-3 py-2 focus:border-accent outline-none text-text-main" placeholder="Tulis info baru..." value={newRunText} onChange={e=>setNewRunText(e.target.value)}/>
                                    <button onClick={addRunText} className="bg-accent text-background-dark px-4 rounded font-bold hover:bg-white transition-colors">Tambah</button>
                                </div>
                                <div className="flex flex-col gap-2">
                                    {(settings.runningText.texts||[]).map((t,i)=>(
                                        <div key={i} className="flex justify-between items-center bg-black/30 p-2 rounded border border-white/5">
                                            <span className="text-sm text-text-muted">{t}</span>
                                            <button onClick={()=>{
                                                const nt = settings.runningText.texts.filter((_,x)=>x!==i);
                                                updateSettings('runningText','texts',nt);
                                            }} className="text-red-400 hover:text-red-300"><span className="material-symbols-outlined text-sm">delete</span></button>
                                        </div>
                                    ))}
                                </div>
                            </section>

                            {/* LOCATION (Simplified for Layout) */}
                            <section className="glass-panel rounded-2xl p-6 border-l-4 border-l-accent">
                                <h3 className="text-lg font-bold text-accent mb-4 flex items-center gap-2"><span className="material-symbols-outlined">location_on</span>Lokasi (Jadwal Sholat)</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <label className="flex flex-col gap-1"><span className="text-sm text-text-muted">Nama Kota</span><input className="bg-black/20 border border-accent/30 rounded px-3 py-2 focus:border-accent outline-none text-text-main" value={settings.location.city} onChange={e=>updateSettings('location','city',e.target.value)}/></label>
                                    <label className="flex flex-col gap-1"><span className="text-sm text-text-muted">Metode</span>
                                        <select className="bg-black/20 border border-accent/30 rounded px-3 py-2 focus:border-accent outline-none text-text-main" value={settings.general.method} onChange={e=>updateSettings('general','method',e.target.value)}>
                                            <option value="20">Kemenag RI</option>
                                            <option value="muhammadiyah">Muhammadiyah</option>
                                        </select>
                                    </label>
                                </div>
                            </section>

                        </div>
                    </main>
                </div>
            );
        };

        const App = () => (
            <SettingsProvider>
                <HashRouter>
                    <Routes>
                        <Route path="/" element={<Dashboard />} />
                        <Route path="/settings" element={<SettingsPage />} />
                    </Routes>
                </HashRouter>
            </SettingsProvider>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
